<!-- Card -->
<div class="mx-auto w-full rounded-2xl bg-white shadow-2xl ring-1 ring-black/5">
  <!-- Header -->
  <div class="flex items-start justify-between px-6 pt-5">
    <h2 class="text-[20px] font-bold text-ra-slate leading-none">{{ titulo() }}</h2>

    <button
      class="w-8 h-8 grid place-items-center rounded-full bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300"
      (click)="cancelar.emit()"
      aria-label="Cerrar">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>

  <!-- Body -->
  <form class="px-6 pb-6 pt-4 space-y-4" (ngSubmit)="guardar()" [formGroup]="formulario">

    <!-- SOLO ADMIN: Gimnasio -->
    @if (isAdmin) {
      <div>
        <label class="block text-sm font-semibold text-ra-slate mb-1.5">Gimnasio</label>
        <div class="relative">
          <!-- OJO: sin [disabled]; el control nace disabled en TS y luego se habilita -->
          <select formControlName="gimnasioId"
                  class="w-full appearance-none rounded-xl border border-gray-200 bg-gray-100 text-gray-900 px-4 py-3 pr-10 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green focus:border-transparent">
            <option [ngValue]="null" disabled>Selecciona un gimnasio</option>
            @for (g of gimnasios; track g.idGimnasio) {
              <option [ngValue]="g.idGimnasio">{{ g.nombre }}</option>
            }
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.06l3.71-3.83a.75.75 0 1 1 1.08 1.04l-4.25 4.39a.75.75 0 0 1-1.08 0L5.21 8.27a.75.75 0 0 1 .02-1.06z" clip-rule="evenodd"/>
            </svg>
          </div>
        </div>

        @if (formulario.controls['gimnasioId'].touched && formulario.controls['gimnasioId'].invalid) {
          <p class="text-sm text-red-600 mt-1">Selecciona un gimnasio.</p>
        }
      </div>
    }

    <!-- Grid avatar + campos -->
    <div class="grid grid-cols-[96px_1fr] gap-4 items-start">
      <!-- Avatar placeholder -->
      <div class="hidden md:block">
        <div class="w-[96px] h-[96px] rounded-xl bg-gray-100 border border-gray-200 grid place-items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M20 21a8 8 0 1 0-16 0M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/>
          </svg>
        </div>
      </div>

      <!-- Campos principales -->
      <div class="space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold text-ra-slate mb-1.5">Nombre</label>
            <input type="text" formControlName="nombre"
                   class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green" />
            @if (formulario.controls['nombre'].touched && formulario.controls['nombre'].invalid) {
              <p class="text-sm text-red-600 mt-1">Requerido.</p>
            }
          </div>
          <div>
            <label class="block text-sm font-semibold text-ra-slate mb-1.5">Apellido</label>
            <input type="text" formControlName="apellido"
                   class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green" />
            @if (formulario.controls['apellido'].touched && formulario.controls['apellido'].invalid) {
              <p class="text-sm text-red-600 mt-1">Requerido.</p>
            }
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold text-ra-slate mb-1.5">Teléfono</label>
            <input type="tel" formControlName="telefono" placeholder="10 dígitos"
                   class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green" />
            @if (formulario.controls['telefono'].touched && formulario.controls['telefono'].invalid) {
              <p class="text-sm text-red-600 mt-1">Teléfono inválido.</p>
            }
          </div>
          <div>
            <label class="block text-sm font-semibold text-ra-slate mb-1.5">Email</label>
            <input type="email" formControlName="email"
                   class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green" />
            @if (formulario.controls['email'].touched && formulario.controls['email'].invalid) {
              <p class="text-sm text-red-600 mt-1">Email inválido.</p>
            }
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Dirección</label>
          <input type="text" formControlName="direccion"
                 class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green" />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-3 items-end">
          <div>
            <label class="block text-sm font-semibold text-ra-slate mb-1.5">Sexo</label>
            <div class="flex items-center gap-5 text-sm">
              <label class="inline-flex items-center gap-2">
                <input type="radio" class="accent-ra-green" value="MASCULINO" formControlName="genero" />
                <span>Masculino</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" class="accent-ra-green" value="FEMENINO" formControlName="genero" />
                <span>Femenino</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" class="accent-ra-green" value="OTRO" formControlName="genero" />
                <span>Otro</span>
              </label>
            </div>
            @if (formulario.controls['genero'].touched && formulario.controls['genero'].invalid) {
              <p class="text-sm text-red-600 mt-1">Selecciona una opción.</p>
            }
          </div>

          <div>
            <label class="block text-sm font-semibold text-ra-slate mb-1.5">Fecha de nacimiento</label>
            <input type="date" formControlName="fechaNacimiento"
                   class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green" />
            @if (formulario.controls['fechaNacimiento'].touched && formulario.controls['fechaNacimiento'].invalid) {
              <p class="text-sm text-red-600 mt-1">Requerido.</p>
            }
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Comentarios</label>
          <textarea rows="3" formControlName="comentarios"
                    class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green"
                    placeholder="Notas del socio"></textarea>
        </div>

        <!-- HUELLAS -->
        <div class="mt-1 rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 flex items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold text-ra-slate">Huella digital</div>
            <div class="text-xs text-gray-600">
              @if (socio?.idSocio) {
                Puedes registrar o actualizar la huella de este socio.
              } @else {
                (Opcional) Captura la huella; se guardará al crear el socio.
              }
            </div>
          </div>
          <div class="flex items-center gap-2">
            @if (huellaProceso()) {
              <span class="text-xs text-ra-slate">Guardando…</span>
            }
            <button
              type="button"
              class="px-4 py-2 rounded-full bg-red-600 text-white text-sm hover:bg-red-700 disabled:opacity-60"
              [disabled]="huellaProceso()"
              (click)="abrirModalHuella()">
              Capturar huella
            </button>
          </div>
        </div>

        @if (huellaMensaje()) {
          <div class="text-xs text-green-700 mt-1">
            {{ huellaMensaje() }}
          </div>
        }

        @if (huellaError()) {
          <div class="text-xs text-red-600 mt-1">
            {{ huellaError() }}
          </div>
        }

      </div>
    </div>

    @if (error) {
      <div class="text-red-600 text-sm">{{ error }}</div>
    }

    <!-- Footer -->
    <div class="flex items-center justify-end gap-2 pt-2">
      <button type="button" (click)="cancelar.emit()"
              class="px-4 py-2 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100">
        Cancelar
      </button>
      <button type="submit" [disabled]="guardando"
              class="px-5 py-2.5 rounded-full bg-[#0B2C4A] text-white hover:bg-[#0A2540] shadow-md disabled:opacity-60">
        {{ guardando ? 'Guardando...' : (socio ? 'Confirmar cambios' : 'Guardar') }}
      </button>
    </div>
  </form>
</div>

<!-- Modal de huella -->
@if (mostrarModalHuella()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-[2px]">
    <app-huella-modal
      [maxMuestras]="1"
      [timeoutMs]="30000"
      (cancelar)="onHuellaCancel()"
      (confirmar)="onHuellaOk($event)">
    </app-huella-modal>
  </div>
}
