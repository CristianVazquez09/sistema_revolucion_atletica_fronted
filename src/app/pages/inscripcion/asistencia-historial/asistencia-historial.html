<!-- Barra superior con filtros (COMPACTO)
     ✅ En md+ (y también lg/xl/2xl): filtros + "Volver" SIEMPRE en la misma fila
     ✅ En <md: puede apilar (normal) -->
<div
  class="ml-2 md:ml-4 mr-2 sm:mr-4 md:mr-8 mb-3
         flex flex-col gap-2
         md:flex-row md:items-center md:justify-between md:gap-3
         min-w-0 max-w-full"
>
  <h1 class="text-lg sm:text-xl lg:text-xl xl:text-2xl font-bold text-ra-slate shrink-0">
    Historial de asistencias
  </h1>

  <!-- ✅ Desde md: NO wrap para que "Volver" no baje -->
  <div
    class="flex flex-col gap-2 min-w-0 max-w-full
           md:flex-row md:flex-nowrap md:items-center md:justify-end md:gap-2"
  >
    <!-- Filtros: en md+ una fila; en <md puede wrap -->
    <div
      class="flex flex-wrap items-center
             md:flex-nowrap
             gap-2 md:gap-1.5 xl:gap-2
             text-[11px] sm:text-xs md:text-[11px] xl:text-sm
             min-w-0 max-w-full
             md:flex-1"
    >
      <!-- Desde -->
      <div class="flex items-center gap-2 md:gap-1.5 min-w-0">
        <!-- visible <md y en 2xl+, oculto en md/lg/xl -->
        <label class="text-ra-slate/80 whitespace-nowrap md:hidden 2xl:inline">Desde</label>
        <input
          type="date"
          class="input-filled
                 w-[135px] sm:w-[155px]
                 md:w-[120px] lg:w-[120px] xl:w-[132px] 2xl:w-[170px]
                 min-w-0
                 text-[11px] sm:text-xs md:text-[11px] xl:text-sm"
          [(ngModel)]="filtroDesde"
        />
      </div>

      <!-- Hasta -->
      <div class="flex items-center gap-2 md:gap-1.5 min-w-0">
        <label class="text-ra-slate/80 whitespace-nowrap md:hidden 2xl:inline">Hasta</label>
        <input
          type="date"
          class="input-filled
                 w-[135px] sm:w-[155px]
                 md:w-[120px] lg:w-[120px] xl:w-[132px] 2xl:w-[170px]
                 min-w-0
                 text-[11px] sm:text-xs md:text-[11px] xl:text-sm"
          [(ngModel)]="filtroHasta"
        />
      </div>

    
      <!-- Nombre socio -->
<!-- Nombre socio (autobúsqueda >= 3 letras) -->
<div class="flex items-center gap-2 md:gap-1.5 min-w-0">
  <label class="text-ra-slate/80 whitespace-nowrap md:hidden 2xl:inline">Nombre</label>

  <input
    type="text"
    class="input-filled
           w-[170px] sm:w-[200px]
           md:w-[150px] lg:w-[170px] xl:w-[200px] 2xl:w-[240px]
           min-w-0
           text-[11px] sm:text-xs md:text-[11px] xl:text-sm"
    placeholder="Nombre o apellido (mín. 3)"
    [ngModel]="filtroNombreSocio"
    (ngModelChange)="onNombreChange($event)"
  />
</div>





      <!-- Botones -->
      <div class="flex items-center gap-2 md:gap-1.5 shrink-0">
        <button
          type="button"
          class="px-3 py-2
                 md:px-2.5 md:py-1.5
                 xl:px-3 xl:py-2
                 rounded-md
                 bg-[color:var(--color-ra-azul-fuerte)] text-white hover:brightness-110
                 shadow-card
                 text-[11px] sm:text-xs md:text-[11px] xl:text-sm"
          (click)="aplicarFiltros()"
        >
          Aplicar
        </button>

        <button
          type="button"
          class="px-3 py-2
                 md:px-2.5 md:py-1.5
                 xl:px-3 xl:py-2
                 rounded-md border
                 text-[11px] sm:text-xs md:text-[11px] xl:text-sm"
          (click)="limpiarFiltros()"
        >
          Limpiar
        </button>
      </div>
    </div>

    <!-- Volver: NO baja desde md+ (shrink-0 + md:flex-nowrap en wrapper) -->
    <a
      routerLink="/pages/inscripcion"
      class="shrink-0 whitespace-nowrap
             inline-flex items-center justify-center gap-2
             px-3 py-2
             md:px-2.5 md:py-1.5
             xl:px-3 xl:py-2.5
             rounded-xl
             bg-[color:var(--color-ra-azul-fuerte)] text-white
             text-[11px] sm:text-xs md:text-[11px] xl:text-sm
             font-medium shadow
             hover:bg-[color:var(--color-ra-azul-fuerte)]/90 transition"
    >
      <svg viewBox="0 0 24 24" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>

      <!-- En md/lg/xl corto; en 2xl completo -->
      <span class="2xl:hidden">Volver</span>
      <span class="hidden 2xl:inline">Volver a inscripción</span>
    </a>
  </div>
</div>






<!-- Tabla -->
<div class="rounded-xl2 ml-2 md:ml-4 mr-2 sm:mr-4 md:mr-8 bg-ra-white shadow-card ring-1 ring-black/10 overflow-hidden min-w-0 max-w-full">
  <!-- ✅ Sin barra horizontal -->
  <div class="overflow-x-hidden min-w-0 max-w-full">
    <div
      class="
        overflow-y-auto
        max-h-[calc(100dvh-240px)]
        min-h-[320px]
        sm:max-h-[calc(100dvh-250px)] sm:min-h-[340px]
        lg:max-h-[calc(100dvh-265px)] lg:min-h-[370px]
        xl:max-h-[calc(100dvh-285px)] xl:min-h-[400px]
        2xl:max-h-[calc(100dvh-305px)] 2xl:min-h-[440px]
        [@media(max-height:900px)]:max-h-[calc(100dvh-200px)]
        [@media(max-height:820px)]:max-h-[calc(100dvh-170px)]
      "
    >
      <table class="w-full min-w-0 table-fixed text-[11px] sm:text-[12px] xl:text-[13px] 2xl:text-[14px]">
        <!-- Sin <col> de Gimnasio para evitar huecos al ocultar -->
        <colgroup>
          <col class="w-14 sm:w-16" />                              <!-- Id -->
          <col class="w-[110px] sm:w-[130px] lg:w-[140px] xl:w-[155px]" /> <!-- Fecha -->
          <col class="w-auto" />                                    <!-- Socio -->
          <col class="hidden lg:table-column w-[110px] xl:w-[120px]" />    <!-- Tel (lg+) -->
          <col class="hidden lg:table-column w-[85px]  xl:w-[95px]" />     <!-- Origen (lg+) -->
          <col class="w-[175px] sm:w-[200px] xl:w-[230px] 2xl:w-[245px]" /><!-- Paquete -->
        </colgroup>

        <!-- Header -->
        <thead class="sticky top-0 z-10 bg-ra-grayLight/70 backdrop-blur">
          <tr class="text-ra-slate">
            <th class="py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-center font-semibold uppercase">Id</th>
            <th class="py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-left   font-semibold uppercase">Fecha</th>
            <th class="py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-left   font-semibold uppercase">Socio</th>

            <th class="hidden lg:table-cell py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-center font-semibold uppercase">Tel</th>
            <th class="hidden lg:table-cell py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-center font-semibold uppercase">Origen</th>

            <th class="py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-left font-semibold uppercase">Paquete</th>

            <!-- Gimnasio (solo Admin)
                 ✅ Visible desde lg+
                 ✅ Menú abierto: OCULTO en lg y xl, VISIBLE en 2xl+ -->
            @if (isAdmin) {
              <th
                class="py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-center font-semibold uppercase w-[170px] 2xl:w-[200px]"
                [ngClass]="menuAbierto()
                  ? 'hidden 2xl:table-cell'
                  : 'hidden lg:table-cell'"
              >
                Gimnasio
              </th>
            }
          </tr>
        </thead>

        <tbody>
          @if (cargando) {
            <tr>
              <td [attr.colspan]="isAdmin ? 7 : 6" class="py-6 px-6 text-center text-ra-slate">Cargando…</td>
            </tr>
          } @else if (mensajeError) {
            <tr>
              <td [attr.colspan]="isAdmin ? 7 : 6" class="py-6 px-6 text-center text-red-600">{{ mensajeError }}</td>
            </tr>
          } @else {
            @if (listaAsistencias.length === 0) {
              <tr>
                <td [attr.colspan]="isAdmin ? 7 : 6" class="py-6 px-6 text-center text-ra-slate">Sin registros de asistencia.</td>
              </tr>
            } @else {
              @for (a of listaAsistencias; track a.idAsistencia) {
                <tr class="border-t border-ra-grayLight/60 hover:bg-ra-bg">
                  <!-- Id -->
                  <td class="py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-center align-top">
                    <span class="inline-block min-w-[3ch] rounded-md border border-gray-200 bg-gray-100 px-2 py-0.5 text-[10px] sm:text-xs font-mono text-gray-700">
                      {{ a.idAsistencia }}
                    </span>
                  </td>

                  <!-- Fecha -->
                  <td class="py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-left align-top min-w-0">
                    <div class="font-medium truncate">
                      {{ a.fechaHora | date:'dd/MM/yyyy' }}
                    </div>
                    <div class="text-[10px] sm:text-xs text-ra-slate/70 truncate">
                      {{ a.fechaHora | date:'HH:mm:ss' }}
                    </div>
                  </td>

                  <!-- Socio -->
                  <td class="py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-left align-top min-w-0">
                    <div class="font-medium truncate">
                      {{ displaySocio(a) }}
                    </div>
                    <div class="text-[10px] sm:text-xs text-ra-slate/70 truncate">
                      ID socio: {{ a.socio.idSocio }}
                    </div>

                    <!-- <lg: Tel + Origen dentro -->
                    <div class="mt-1 lg:hidden text-[10px] sm:text-xs text-ra-slate/70">
                      <div class="flex flex-wrap gap-x-3 gap-y-0.5">
                        <span class="inline-flex items-center gap-1 min-w-0">
                          <span class="text-ra-slate/60">Tel:</span>
                          <span class="font-medium truncate" [title]="displayTelefono(a)">
                            {{ displayTelefono(a) }}
                          </span>
                        </span>

                        <span class="inline-flex items-center gap-1">
                          <span class="text-ra-slate/60">Origen:</span>
                          <span class="font-medium">{{ a.origen }}</span>
                        </span>
                      </div>
                    </div>
                  </td>

                  <!-- Tel (lg+) -->
                  <td class="hidden lg:table-cell py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-center truncate align-top" [title]="displayTelefono(a)">
                    {{ displayTelefono(a) }}
                  </td>

                  <!-- Origen (lg+) -->
                  <td class="hidden lg:table-cell py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-center align-top">
                    <span
                      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] sm:text-xs font-semibold"
                      [ngClass]="{
                        'bg-blue-100 text-blue-700': a.origen === 'HUELLA',
                        'bg-amber-100 text-amber-700': a.origen === 'MANUAL',
                        'bg-gray-100 text-gray-700': a.origen !== 'HUELLA' && a.origen !== 'MANUAL'
                      }"
                    >
                      {{ a.origen }}
                    </span>
                  </td>

                  <!-- Paquete -->
                  <td class="py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-left align-top min-w-0">
                    <div class="flex flex-col gap-1 min-w-0">
                      <!-- IMPORTANTE: sin w-fit para no desbordar -->
                      <span
                        class="inline-flex items-center gap-1 rounded-full bg-[color:var(--color-ra-azul-fuerte)]/10
                               text-[color:var(--color-ra-azul-fuerte)] px-2 py-0.5 text-[10px] sm:text-xs font-semibold max-w-full"
                        [title]="displayPaqueteNombre(a)"
                      >
                        <svg viewBox="0 0 24 24" class="w-3.5 h-3.5 sm:w-4 sm:h-4 shrink-0" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 7h10M7 12h10M7 17h10" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                        <span class="truncate min-w-0">{{ displayPaqueteNombre(a) }}</span>
                      </span>

                      @if (a?.paquete?.tiempo) {
                        <div class="text-[10px] sm:text-xs text-ra-slate/70 truncate" [title]="a.paquete?.tiempo">
                          {{ a.paquete?.tiempo | tiempoPlan }}
                          @if (a?.paquete?.tipoPaquete) { <span> · {{ a?.paquete?.tipoPaquete }}</span> }
                          @if (a?.paquete?.visitasMaximas != null) { <span> · Visitas: {{ a?.paquete?.visitasMaximas }}</span> }
                          @if (a?.paquete?.soloFinesDeSemana) { <span> · Solo finde</span> }
                        </div>
                      } @else {
                        <div class="text-[10px] sm:text-xs text-ra-slate/40">—</div>
                      }
                    </div>
                  </td>

                  <!-- Gimnasio (solo Admin) -->
                  @if (isAdmin) {
                    <td
                      class="py-1.5 sm:py-2 xl:py-2.5 px-2 sm:px-3 text-center align-top min-w-0 w-[170px] 2xl:w-[200px]"
                      [ngClass]="menuAbierto()
                        ? 'hidden 2xl:table-cell'
                        : 'hidden lg:table-cell'"
                    >
                      <!-- sin w-fit para no desbordar -->
                      <span
                        class="inline-flex items-center gap-1 rounded-full bg-[color:var(--color-ra-azul-fuerte)]/10
                               text-[color:var(--color-ra-azul-fuerte)] px-2 py-0.5 text-[10px] sm:text-xs max-w-full"
                        [title]="displayGimnasio(a)"
                      >
                        <svg viewBox="0 0 24 24" class="w-3.5 h-3.5 sm:w-4 sm:h-4 shrink-0" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M3 21h18M6 21V5h6v16M12 9h6v12"></path>
                        </svg>
                        <span class="truncate min-w-0">{{ displayGimnasio(a) }}</span>
                      </span>
                    </td>
                  }
                </tr>
              }
            }
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Paginador -->
  <div class="pager">
    <div class="pager-row">
      <div class="pager-select">
        <span class="text-sm text-[color:var(--color-ra-slate)]">Mostrar</span>
        <select class="pager-select-el" [ngModel]="tamanioPagina" (ngModelChange)="cambiarTamanioPagina($event)">
          @for (t of tamaniosDisponibles; track t) { <option [ngValue]="t">{{ t }}</option> }
        </select>
        <span class="text-sm text-[color:var(--color-ra-slate)]">por página</span>
      </div>

      <nav class="pager-nav" aria-label="Paginación">
        <button class="pager-btn pager-btn--ghost" (click)="irPrimera()"  [disabled]="paginaActual === 0" title="Primera">«</button>
        <button class="pager-btn pager-btn--ghost" (click)="irAnterior()" [disabled]="paginaActual === 0" title="Anterior">‹</button>
        <button class="pager-btn pager-btn--primary" (click)="irSiguiente()" [disabled]="paginaActual + 1 >= totalPaginas" title="Siguiente">Siguiente ›</button>
        <button class="pager-btn pager-btn--ghost" (click)="irUltima()"   [disabled]="paginaActual + 1 >= totalPaginas" title="Última">»</button>
      </nav>

      <div class="pager-info">
        Mostrando <strong>{{ rangoDesde }}</strong>–<strong>{{ rangoHasta }}</strong>
        de <strong>{{ totalElementos }}</strong>
        @if (tamanioPagina > 0) { <span>(Página {{ paginaActual + 1 }} de {{ totalPaginas }})</span> }
      </div>
    </div>
  </div>
</div>
