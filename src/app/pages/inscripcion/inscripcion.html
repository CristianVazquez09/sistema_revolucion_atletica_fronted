<!-- pages/inscripcion/inscripcion.html -->

<div class="relative">
  <!-- ✅ CONTENIDO ESCALADO (SIN MODALES ADENTRO) -->
  <div
    class="
      origin-top-left
      [@media(max-width:1280px)]:scale-[0.96] [@media(max-width:1280px)]:w-[calc(100%/0.96)]
      [@media(max-width:1150px)]:scale-[0.92] [@media(max-width:1150px)]:w-[calc(100%/0.92)]
      [@media(max-width:1024px)]:scale-[0.88] [@media(max-width:1024px)]:w-[calc(100%/0.88)]
      [@media(max-width:920px)]:scale-[0.82]  [@media(max-width:920px)]:w-[calc(100%/0.82)]
      [@media(max-width:820px)]:scale-[0.76]  [@media(max-width:820px)]:w-[calc(100%/0.76)]
      [@media(max-height:820px)]:scale-[0.92] [@media(max-height:820px)]:w-[calc(100%/0.92)]
      [@media(max-height:760px)]:scale-[0.88] [@media(max-height:760px)]:w-[calc(100%/0.88)]
    "
  >
    <div class="flex flex-nowrap gap-3 px-4 md:px-8 mb-4">
      <button
        type="button"
        class="px-5 py-2 rounded-md bg-red-600 text-white shadow-md hover:bg-red-700 whitespace-nowrap"
      >
        Agregar Socio
      </button>

      <button
        type="button"
        [routerLink]="['/pages/agregar-membresia']"
        class="px-5 py-2 rounded-md bg-red-600 text-white shadow-md hover:bg-red-700 whitespace-nowrap"
      >
        Agregar Membresia
      </button>

      <button
        type="button"
        [routerLink]="['/pages/historial']"
        class="px-5 py-2 rounded-md bg-red-600 text-white shadow-md hover:bg-red-700 whitespace-nowrap"
      >
        Historial
      </button>

      <button
        type="button"
        [routerLink]="['/pages/historial-asistencias']"
        class="px-5 py-2 rounded-md bg-red-600 text-white shadow-md hover:bg-red-700 whitespace-nowrap"
      >
        Asistencias
      </button>

      <button
        type="button"
        [routerLink]="['/pages/reinscripcion-adelantada']"
        class="px-5 py-2 rounded-md bg-red-600 text-white shadow-md hover:bg-red-700 whitespace-nowrap"
      >
        Reinscripcion Adelantada
      </button>
    </div>

    @if (batchActivoSig() && paqueteActualSig()) {
      <div class="mx-4 md:mx-8 mb-4 rounded-xl2 bg-white ring-1 ring-black/10 shadow-card">
        <div class="px-6 py-4 flex items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold text-ra-slate">
              Lote activo · Integrante {{ batchPasoSig() }} de {{ batchRequeridoSig() }}
            </div>

            @if (batchDraftsSig().length > 0) {
              <div class="text-xs text-ra-slate/70 mt-1">
                Capturados:
                <span class="font-semibold">{{ batchDraftsSig().length }}</span>
                / {{ batchRequeridoSig() }}
                <span class="ml-2">· Click en un capturado para editar</span>
              </div>
            }
          </div>

          <div class="flex items-center gap-2">
            @if (batchDraftsSig().length > 0) {
              <button
                type="button"
                class="px-3 py-2 rounded-md border border-gray-300 bg-white hover:bg-gray-50 text-xs whitespace-nowrap"
                (click)="editarAnteriorCapturado()"
              >
                Editar anterior
              </button>

              <button
                type="button"
                class="px-3 py-2 rounded-md border border-gray-300 bg-white hover:bg-gray-50 text-xs whitespace-nowrap"
                (click)="editarPrimeroCapturado()"
              >
                Editar primero
              </button>
            }

            <button
              type="button"
              class="px-4 py-2 rounded-md border border-gray-300 bg-white hover:bg-gray-50 text-sm whitespace-nowrap"
              (click)="reiniciarLote()"
            >
              Reiniciar lote
            </button>
          </div>
        </div>

        @if (batchDraftsSig().length > 0) {
          <div class="px-6 pb-4 flex flex-wrap gap-2">
            @for (d of batchDraftsSig(); track $index) {
              <button
                type="button"
                class="px-3 py-1 rounded-full bg-gray-100 text-xs text-ra-slate hover:bg-gray-200"
                (click)="editarIntegrante($index)"
                [title]="'Editar integrante ' + ($index + 1)"
              >
                {{ $index + 1 }}. {{ d.socioNombre }}
              </button>
            }
          </div>
        }
      </div>
    }

    <div class="mx-4 md:mx-8 mt-4 rounded-xl2 bg-white ring-1 ring-black/10 shadow-card">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <div class="flex flex-col">
          <h2 class="text-xl font-semibold text-ra-slate">Agregar Usuario</h2>

          @if (editandoIntegranteSig()) {
            <div class="text-xs text-amber-700 mt-1">
              Estás editando un integrante capturado. Guarda cambios o cancela para continuar.
            </div>
          }
        </div>

        @if (batchActivoSig()) {
          <div class="text-sm text-ra-slate/70">
            Integrante <span class="font-semibold">{{ batchPasoSig() }}</span> / {{ batchRequeridoSig() }}
          </div>
        }
      </div>

      <form class="p-6 space-y-4" [formGroup]="formularioInscripcion">
        <div class="grid grid-cols-2 gap-4">
          <input formControlName="nombre" placeholder="Nombre*" class="input-filled" />
          <input formControlName="apellido" placeholder="Apellidos*" class="input-filled" />
        </div>

        <div class="grid grid-cols-[1fr_1fr_1fr] gap-4">
          <input
            type="tel"
            formControlName="telefono"
            placeholder="Teléfono* (10 dígitos)"
            class="input-filled"
            inputmode="numeric"
          />
          <input formControlName="email" placeholder="Correo (opcional)" class="input-filled" />

          <input
            type="date"
            formControlName="fechaNacimiento"
            class="input-filled"
            aria-label="Fecha de nacimiento"
            title="Fecha de nacimiento"
          />
        </div>

        <!-- ✅ Paquete estudiantil: mostrar vigencia credencial -->
        @if (esPaqueteEstudiantilSig()) {
          <div class="grid grid-cols-[320px_1fr] gap-4 items-center">
            <label class="text-sm font-semibold text-ra-slate">
              Vigencia credencial estudiante*
            </label>
            <input
              type="date"
              formControlName="credencialEstudianteVigencia"
              class="input-filled"
              aria-label="Vigencia credencial estudiante"
              title="Vigencia credencial estudiante"
            />
          </div>
          <div class="text-xs text-ra-slate/70">
            Se valida: edad ≤ 22 años y vigencia ≥ hoy.
          </div>
        }

        <div class="grid grid-cols-[1fr_auto] gap-4 items-center">
          <input formControlName="direccion" placeholder="Dirección*" class="input-filled" />

          <div class="text-sm text-ra-slate whitespace-nowrap">
            <span class="font-semibold mr-2">Sexo*</span>
            <label class="mr-4 inline-flex items-center gap-2">
              <input type="radio" value="MASCULINO" formControlName="genero" class="accent-red-600" />
              Masculino
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" value="FEMENINO" formControlName="genero" class="accent-red-600" />
              Femenino
            </label>
          </div>
        </div>

        <!-- ✅ FIX: evitar que Foto/Huella/Comentarios se “estiren” por la columna de Paquete -->
        <!-- - Se cambia items-stretch por items-start -->
        <!-- - Se hace responsive: en md se acomoda a 2 columnas -->
        <!-- - Comentarios mantiene altura similar a las tarjetas -->
        <div
          class="
            grid gap-4 items-start
            grid-cols-1
            md:grid-cols-2
            xl:grid-cols-[240px_240px_1.1fr_1.2fr]
            2xl:grid-cols-[260px_260px_1.1fr_1.2fr]
          "
        >
          <!-- FOTO -->
          <div class="rounded-xl2 border border-gray-300 bg-gray-50 p-2 aspect-square self-start">
            @if (fotoPreviewUrl) {
              <div class="relative w-full h-full">
                <img
                  [src]="fotoPreviewUrl"
                  alt="Foto"
                  class="absolute inset-0 w-full h-full object-cover rounded-xl2"
                />
                <div class="absolute bottom-2 left-0 right-0 flex justify-center gap-2">
                  <label class="px-3 py-1.5 rounded-md bg-white/90 border cursor-pointer hover:bg-white">
                    Cambiar
                    <input type="file" accept="image/*" class="hidden" (change)="onFotoSeleccionada($event)" />
                  </label>
                  <button
                    type="button"
                    class="px-3 py-1.5 rounded-md bg-white/90 border hover:bg-white"
                    (click)="quitarFoto()"
                  >
                    Quitar
                  </button>
                </div>
              </div>
            } @else {
              <div class="w-full h-full grid place-items-center text-center">
                <div>
                  <div class="mx-auto mb-3 h-12 w-12 grid place-items-center">
                    <img src="iconos/subir-archivo.svg" alt="Icono subir" class="w-6 h-6" />
                  </div>
                  <label class="px-4 py-2 rounded-md text-gray-700 hover:bg-gray-200 cursor-pointer">
                    Subir archivo
                    <input type="file" accept="image/*" class="hidden" (change)="onFotoSeleccionada($event)" />
                  </label>
                </div>
              </div>
            }
          </div>

          <!-- HUELLA -->
          <div class="rounded-xl2 border border-gray-300 bg-gray-50 p-2 aspect-square self-start">
            <div class="w-full h-full grid place-items-center text-center">
              <div>
                <div class="mx-auto mb-3 h-12 w-12 rounded-full bg-gray-200 grid place-items-center">
                  <svg viewBox="0 0 24 24" class="h-6 w-6 text-gray-600" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 11c1.657 0 3 1.343 3 3v4" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 9a3 3 0 016 0v2" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 12a5 5 0 0110 0v2" />
                  </svg>
                </div>

                <div class="space-y-2">
                  <button
                    type="button"
                    class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700"
                    (click)="abrirModalHuella()"
                  >
                    Ingresar huella
                  </button>

                  @if (huellaDigitalBase64) {
                    <div class="text-xs text-green-700">Huella capturada (opcional) ✓</div>
                  }
                </div>
              </div>
            </div>
          </div>

          <!-- COMENTARIOS -->
          <div
            class="
              rounded-xl2 border border-gray-300 bg-gray-50 p-2
              self-start
              h-[240px] 2xl:h-[260px]
              flex
              md:col-span-2 xl:col-span-1
            "
          >
            <textarea
              formControlName="comentarios"
              class="input-filled h-full w-full resize-none min-h-0"
              placeholder="Comentarios (opcional)"
            ></textarea>
          </div>

          <!-- PAQUETE / PAGO -->
          <div class="h-full flex flex-col self-start md:col-span-2 xl:col-span-1">
            <select formControlName="paqueteId" class="input-filled">
              <option [ngValue]="0" disabled>Seleccionar paquete*</option>
              @for (p of listaPaquetes; track p.idPaquete) {
                <option [ngValue]="p.idPaquete">
                  {{ p.nombre }} — {{ p.tiempo | tiempoPlan }} · {{ modalidadTexto(p.modalidad) }}
                  @if (p.estudiantil) { · Estudiantil }
                </option>
              }
            </select>

            @if (batchIniciadoSig()) {
              <div class="mt-1 text-xs text-ra-slate/70">
                Paquete bloqueado. Para cambiarlo, reinicia el lote.
              </div>
            }

            @if (promoCargandoSig()) {
              <div class="mt-2 text-xs text-ra-slate/70">
                Cargando promoción del paquete...
              </div>
            }

            @if (!promoCargandoSig() && promocionAplicadaSig()) {
              <div class="mt-3 rounded-xl2 border border-emerald-200 bg-emerald-50 p-3">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="text-sm font-semibold text-emerald-900">
                      Promoción activa: {{ promocionAplicadaSig()?.nombre || '—' }}
                    </div>

                    @if (promocionAplicadaSig()?.descripcion) {
                      <div class="text-xs text-emerald-900/80 mt-1">
                        {{ promocionAplicadaSig()?.descripcion }}
                      </div>
                    }

                    @if (promoBadgeTextoSig()) {
                      <div class="mt-2">
                        <span class="inline-flex items-center rounded-full px-2.5 py-1 text-[11px] font-semibold bg-white/80 border border-emerald-200 text-emerald-900">
                          {{ promoBadgeTextoSig() }}
                        </span>
                      </div>
                    }

                    @if (promoMesesGratisSig() > 0) {
                      <div class="text-[11px] text-emerald-900/80 mt-2">
                        Nota: meses gratis se reflejan en la vigencia.
                      </div>
                    }
                  </div>

                  <div class="text-right whitespace-nowrap">
                    <div class="text-[11px] text-emerald-900/70">Ahorro</div>
                    <div class="text-sm font-bold text-emerald-900">
                      ${{ ahorroPromoSig() | number: '1.2-2' }}
                    </div>
                  </div>
                </div>
              </div>
            }

            @if (!promoCargandoSig() && promoErrorSig()) {
              <div class="mt-2 text-xs text-red-700">
                No se pudo cargar la promoción del paquete: {{ promoErrorSig() }}
              </div>
            }

            <input
              type="number"
              step="0.01"
              formControlName="descuento"
              placeholder="Descuento (opcional)"
              class="input-filled mt-3"
              [disabled]="editandoIntegranteSig()"
            />

            @if (editandoIntegranteSig()) {
              <div class="mt-1 text-xs text-amber-700">
                Nota: en edición no se recomienda cambiar descuento (pagos ya capturados).
              </div>
            }

            <label class="block text-sm font-semibold text-ra-slate mt-3 mb-1">
              Fecha de pago
            </label>
            <div class="input-filled bg-gray-100 pointer-events-none select-none">
              {{ fechaPagoVistaSig() | date: 'dd/MM/yyyy' }}
            </div>

            <input type="hidden" formControlName="fechaInicio" />
          </div>
        </div>

        <div class="grid grid-cols-3 gap-4 text-sm">
          <div class="rounded-lg bg-gray-50 border border-gray-200 p-3">
            <div class="text-gray-600">Precio paquete</div>
            <div class="font-semibold">${{ precioPaqueteSig() | number: '1.2-2' }}</div>
          </div>
          <div class="rounded-lg bg-gray-50 border border-gray-200 p-3">
            <div class="text-gray-600">Inscripción</div>
            <div class="font-semibold">
              @if (promoInscripcionGratisSig()) {
                <span class="line-through text-gray-400 mr-1">${{ costoInscripcionSig() | number: '1.2-2' }}</span>
                <span>$0.00</span>
              } @else {
                ${{ costoInscripcionSig() | number: '1.2-2' }}
              }
            </div>
          </div>
          <div class="rounded-lg bg-gray-50 border border-gray-200 p-3">
            <div class="text-gray-600">Total (con descuento)</div>
            <div class="font-bold text-ra-slate">${{ totalConPromoSig() | number: '1.2-2' }}</div>
            @if (promocionAplicadaSig()) {
              <div class="text-[11px] text-emerald-700 mt-1">
                Incluye promoción activa.
              </div>
            }
          </div>
        </div>

        @if (mensajeError) {
          <div class="text-red-600 text-sm mt-2">{{ mensajeError }}</div>
        }

        <div class="pt-4 flex justify-center gap-3">
          @if (!editandoIntegranteSig()) {
            <button
              type="button"
              (click)="abrirModalResumen()"
              [disabled]="guardandoMembresia || !puedeAbrirResumen()"
              class="px-8 py-2.5 rounded-md text-white
                     disabled:opacity-50 disabled:cursor-not-allowed
                     bg-red-600 hover:bg-red-700"
            >
              {{ botonContinuarSig() }}
            </button>
          } @else {
            <button
              type="button"
              (click)="guardarEdicionIntegrante()"
              [disabled]="guardandoMembresia"
              class="px-6 py-2.5 rounded-md text-white bg-amber-600 hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Guardar cambios
            </button>

            <button
              type="button"
              (click)="cancelarEdicionIntegrante()"
              [disabled]="guardandoMembresia"
              class="px-6 py-2.5 rounded-md border border-gray-300 bg-white hover:bg-gray-50 text-ra-slate disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Cancelar edición
            </button>
          }
        </div>

        @if (!puedeAbrirResumen() && (formularioInscripcion.touched || formularioInscripcion.dirty) && !editandoIntegranteSig()) {
          <div class="text-xs text-ra-slate/70 text-center pt-2">
            Completa los campos requeridos y valida Estudiante si aplica.
          </div>
        }
      </form>
    </div>
  </div>

  <!-- ✅ MODALES FUERA DEL CONTENEDOR CON SCALE/TRANSFORM -->
  @if (mostrarModalResumen()) {
    <div class="fixed inset-0 z-[999] flex items-center justify-center p-4" (click)="cerrarModalResumen()">
      <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]"></div>

      <div class="relative z-10 w-full max-w-[560px]" (click)="$event.stopPropagation()">
        <app-resumen-compra
          [resetKey]="resumenResetKeySig()"
          [socioNombre]="socioNombreActual()"
          [fechaPago]="fechaPagoVistaSig()"
          [concepto]="conceptoResumenSig()"
          [montoPaquete]="montoPaqueteEnModalSig()"
          [montoInscripcion]="montoInscripcionEnModalSig()"
          [descuento]="descuentoEnModalSig()"
          [total]="totalEnModalSig()"
          [guardando]="guardandoMembresia"
          (cancelar)="cerrarModalResumen()"
          (confirmar)="confirmarPagoYGuardar($event)"
        >
        </app-resumen-compra>
      </div>
    </div>
  }

  @if (mostrarModalHuella()) {
    <app-huella-modal (cancelar)="onHuellaCancel()" (confirmar)="onHuellaOk($event)"></app-huella-modal>
  }
</div>
