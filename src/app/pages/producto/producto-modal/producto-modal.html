<div class="mx-auto w-full rounded-2xl bg-white shadow-2xl ring-1 ring-black/5">

  <!-- Header -->
  <div class="flex items-start justify-between px-6 pt-5">
    <h2 class="text-[20px] font-bold text-ra-slate leading-none">{{ titulo() }}</h2>
    <button type="button"
            class="w-8 h-8 grid place-items-center rounded-full bg-red-600 text-white hover:bg-red-700"
            (click)="cancelar.emit()" aria-label="Cerrar">✕</button>
  </div>

  <!-- Form -->
  <form class="px-6 pb-6 pt-4 space-y-4" [formGroup]="form" (ngSubmit)="submit()">

    <!-- SOLO ADMIN: Gimnasio -->
    @if (isAdmin) {
      <div>
        <label class="block text-sm font-semibold text-ra-slate mb-1.5">Gimnasio</label>
        <select class="input-filled" formControlName="gimnasioId">
          <option [ngValue]="null" disabled>Selecciona un gimnasio</option>
          @for (g of gimnasios; track g.idGimnasio) {
            <option [ngValue]="g.idGimnasio">{{ g.nombre }}</option>
          }
        </select>
        @if ((intentoGuardar || form.controls.gimnasioId.touched) && form.controls.gimnasioId.invalid) {
          <p class="text-sm text-red-600 mt-1">Selecciona un gimnasio.</p>
        }
      </div>
    }

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-semibold text-ra-slate mb-1.5">Nombre</label>
        <input formControlName="nombre" class="input-filled" placeholder="Nombre del producto">
      </div>

      <div>
        <label class="block text-sm font-semibold text-ra-slate mb-1.5">Código</label>
        <input formControlName="codigo" class="input-filled" placeholder="Código interno / SKU">
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-semibold text-ra-slate mb-1.5">Precio de compra</label>
        <input type="number" step="0.01" formControlName="precioCompra" class="input-filled" placeholder="0.00">
      </div>
      <div>
        <label class="block text-sm font-semibold text-ra-slate mb-1.5">Precio de venta</label>
        <input type="number" step="0.01" formControlName="precioVenta" class="input-filled" placeholder="0.00">
      </div>
      <div>
        <label class="block text-sm font-semibold text-ra-slate mb-1.5">Cantidad</label>
        <input type="number" step="1" formControlName="cantidad" class="input-filled" placeholder="0">
      </div>
    </div>

    <div>
      <label class="block text-sm font-semibold text-ra-slate mb-1.5">
        Categoría
        @if (isAdmin && form.controls.gimnasioId.value != null) {
          <span class="ml-1 text-xs text-gray-500">({{ gimNombrePorId(form.controls.gimnasioId.value) }})</span>
        }
      </label>

      <select formControlName="idCategoria" class="input-filled">
        <option [ngValue]="null" disabled>Selecciona una categoría</option>
        @for (c of categoriasFiltradas; track (c.idCategoria ?? $index)) {
          <option [ngValue]="c.idCategoria">{{ catOptionText(c) }}</option>
        }
      </select>

      @if (isAdmin && !cargandoCategorias && form.controls.gimnasioId.value != null && !categoriasFiltradas.length) {
        <p class="text-sm text-gray-600 mt-1">No hay categorías en este gimnasio.</p>
      }
    </div>

    @if (error) { <div class="text-red-600 text-sm">{{ error }}</div> }

    <div class="flex items-center justify-end gap-2 pt-2">
      <button type="button"
              (click)="cancelar.emit()"
              class="px-4 py-2 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100">Cancelar</button>
      <button type="submit"
              [disabled]="guardando"
              class="px-5 py-2.5 rounded-full bg-[#0B2C4A] text-white hover:bg-[#0A2540] shadow-md disabled:opacity-60">
        {{ guardando ? 'Guardando…' : 'Guardar' }}
      </button>
    </div>
  </form>
</div>
