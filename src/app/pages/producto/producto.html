<!-- Barra superior -->
<div class="mx-4 md:mx-10 mb-4 flex items-center justify-between gap-3">
  <!-- Acciones izquierda -->
  <div class="flex flex-wrap items-center gap-2">
    <a
      routerLink="/pages/inventario"
      class="
        inline-flex items-center justify-center rounded-md bg-ra-rojo-oscuro text-white hover:bg-red-700 shadow-card
        px-2.5 py-1.5 text-xs
        lg:px-3 lg:py-1.5 lg:text-sm
        xl:px-3.5 xl:py-2 xl:text-sm
        2xl:px-4 2xl:py-2 2xl:text-base
        whitespace-nowrap
      "
    >
      Inventario
    </a>

    <a
      routerLink="/pages/categoria"
      class="
        inline-flex items-center justify-center rounded-md bg-ra-rojo-oscuro text-white hover:bg-red-700 shadow-card
        px-2.5 py-1.5 text-xs
        lg:px-3 lg:py-1.5 lg:text-sm
        xl:px-3.5 xl:py-2 xl:text-sm
        2xl:px-4 2xl:py-2 2xl:text-base
        whitespace-nowrap
      "
    >
      Categorías
    </a>
  </div>

  <!-- Agregar -->
  <button
    (click)="abrirCrear()"
    class="
      inline-flex items-center justify-center rounded-md bg-ra-azul-fuerte text-white hover:brightness-110 shadow-card
      px-2.5 py-1.5 text-xs
      lg:px-3 lg:py-1.5 lg:text-sm
      xl:px-3.5 xl:py-2 xl:text-sm
      2xl:px-4 2xl:py-2 2xl:text-base
      whitespace-nowrap
    "
    title="Agregar producto"
  >
    <img src="iconos/agregar.svg" alt="" class="w-4 h-4 lg:w-[18px] lg:h-[18px] xl:w-5 xl:h-5 mr-2" />
    Agregar
  </button>
</div>

<!-- Contenedor -->
<div class="shadow-card rounded-xl2 mx-4 md:mx-10 bg-ra-white ring-1 ring-black/10 overflow-hidden">
  <!-- <xl: sin scroll horizontal; xl+: si hace falta, se permite -->
  <div class="overflow-x-hidden xl:overflow-x-auto">
    <div
      class="
        overflow-y-auto
        max-h-[calc(100dvh-220px)]
        min-h-[320px]
        sm:max-h-[calc(100dvh-230px)] sm:min-h-[340px]
        md:max-h-[calc(100dvh-240px)] md:min-h-[360px]
        lg:max-h-[calc(100dvh-250px)] lg:min-h-[380px]
        xl:max-h-[calc(100dvh-270px)] xl:min-h-[420px]
        2xl:max-h-[calc(100dvh-290px)] 2xl:min-h-[460px]
        [@media(max-height:900px)]:max-h-[calc(100dvh-180px)]
        [@media(max-height:820px)]:max-h-[calc(100dvh-140px)]
      "
    >
      <table
        class="
          w-full min-w-0
          table-auto 2xl:table-fixed
          text-[11px] sm:text-[12px]
          lg:text-[10.5px] xl:text-[11px] 2xl:text-[12px]
          2xl:min-w-[980px]
        "
      >
        <colgroup>
          <!-- ID -->
          <col class="w-[68px] lg:w-[60px] xl:w-[64px] 2xl:w-[72px]" />

          <!-- Nombre -->
          <col class="w-auto 2xl:w-[260px]" />

          <!-- ✅ Código (lg+), pero si menú abierto: oculto en lg<xl y solo aparece en xl+ -->
          <col
            [ngClass]="menuAbierto()
              ? 'hidden xl:table-column xl:w-[130px] 2xl:w-[140px]'
              : 'hidden lg:table-column lg:w-[120px] xl:w-[130px] 2xl:w-[140px]'"
          />

          <!-- Detalles (solo <lg): código + precios + cantidad + categoría -->
          <col class="lg:hidden w-[320px]" />

          <!-- Compra / Venta / Cantidad / Categoría (lg+) -->
          <col class="hidden lg:table-column lg:w-[135px] xl:w-[140px] 2xl:w-[150px]" /> <!-- Compra -->
          <col class="hidden lg:table-column lg:w-[135px] xl:w-[140px] 2xl:w-[150px]" /> <!-- Venta -->
          <col class="hidden lg:table-column lg:w-[95px]  xl:w-[105px]  2xl:w-[120px]" /> <!-- Cantidad -->
          <col class="hidden lg:table-column lg:w-[160px] xl:w-[170px] 2xl:w-[190px]" /> <!-- Categoría -->

          <!-- Gimnasio (admin, xl+) -->
          @if (isAdmin) {
            <col class="hidden xl:table-column xl:w-[180px] 2xl:w-[200px]" />
          }

          <!-- Acciones -->
          <col class="w-[132px] xl:w-[140px] 2xl:w-[152px]" />
        </colgroup>

        <thead class="sticky top-0 bg-ra-grayLight/40 z-10 backdrop-blur">
          <tr class="text-ra-slate">
            <th
              class="
                py-2 lg:py-1.5 2xl:py-2.5
                px-3 sm:px-4 lg:px-3.5 2xl:px-6
                text-center font-semibold uppercase
                text-[10px] sm:text-[11px] lg:text-[10px] xl:text-[10.5px] 2xl:text-[12px]
              "
            >
              ID
            </th>

            <th
              class="
                py-2 lg:py-1.5 2xl:py-2.5
                px-3 sm:px-4 lg:px-3.5 2xl:px-6
                text-left font-semibold uppercase
                text-[10px] sm:text-[11px] lg:text-[10px] xl:text-[10.5px] 2xl:text-[12px]
              "
            >
              Nombre
            </th>

            <th
              class="
                py-2 lg:py-1.5 2xl:py-2.5
                px-3 sm:px-4 lg:px-3.5 2xl:px-6
                text-center font-semibold uppercase
                text-[10px] sm:text-[11px] lg:text-[10px] xl:text-[10.5px] 2xl:text-[12px]
              "
              [ngClass]="menuAbierto() ? 'hidden xl:table-cell' : 'hidden lg:table-cell'"
            >
              Código
            </th>

            <!-- <lg -->
            <th
              class="
                lg:hidden
                py-2
                px-3 sm:px-4
                text-left font-semibold uppercase
                text-[10px] sm:text-[11px]
              "
            >
              Detalles
            </th>

            <th class="hidden lg:table-cell py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center font-semibold uppercase text-[10px] sm:text-[11px] lg:text-[10px] xl:text-[10.5px] 2xl:text-[12px]">
              Compra
            </th>

            <th class="hidden lg:table-cell py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center font-semibold uppercase text-[10px] sm:text-[11px] lg:text-[10px] xl:text-[10.5px] 2xl:text-[12px]">
              Venta
            </th>

            <th class="hidden lg:table-cell py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center font-semibold uppercase text-[10px] sm:text-[11px] lg:text-[10px] xl:text-[10.5px] 2xl:text-[12px]">
              Cantidad
            </th>

            <th class="hidden lg:table-cell py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center font-semibold uppercase text-[10px] sm:text-[11px] lg:text-[10px] xl:text-[10.5px] 2xl:text-[12px]">
              Categoría
            </th>

            @if (isAdmin) {
              <th class="hidden xl:table-cell py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center font-semibold uppercase text-[10px] sm:text-[11px] lg:text-[10px] xl:text-[10.5px] 2xl:text-[12px]">
                Gimnasio
              </th>
            }

            <th class="py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center font-semibold uppercase text-[10px] sm:text-[11px] lg:text-[10px] xl:text-[10.5px] 2xl:text-[12px]">
              Acciones
            </th>
          </tr>
        </thead>

        <tbody>
          @if (loading) {
            <tr>
              <td [attr.colspan]="99" class="py-6 px-6 text-center text-ra-slate">Cargando…</td>
            </tr>
          } @else if (error) {
            <tr>
              <td [attr.colspan]="99" class="py-6 px-6 text-center text-red-600">{{ error }}</td>
            </tr>
          } @else if (productos.length === 0) {
            <tr>
              <td [attr.colspan]="99" class="py-6 px-6 text-center text-ra-slate">Sin resultados.</td>
            </tr>
          } @else {
            @for (p of productos; track p.idProducto ?? $index) {
              <tr class="border-t border-ra-grayLight/60 hover:bg-ra-bg">
                <!-- ID -->
                <td class="py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center align-top">
                  <span class="inline-block min-w-[3ch] rounded-md border border-gray-200 bg-gray-100 px-2 py-0.5 text-[10px] sm:text-[11px] 2xl:text-xs font-mono text-gray-700">
                    {{ p.idProducto }}
                  </span>
                </td>

                <!-- Nombre -->
                <td class="py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-left min-w-0 align-top">
                  <div class="font-medium truncate" [title]="p.nombre">{{ p.nombre }}</div>

                  @if (isAdmin) {
                    <div class="xl:hidden mt-1">
                      <span
                        class="inline-flex items-center gap-1 rounded-full bg-[color:var(--color-ra-azul-fuerte)]/10 text-[color:var(--color-ra-azul-fuerte)] px-2 py-0.5 text-[10px] font-semibold max-w-full"
                        [title]="gymLabel(p.gimnasio)"
                      >
                        <svg viewBox="0 0 24 24" class="w-3.5 h-3.5 shrink-0" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M3 21h18M6 21V5h6v16M12 9h6v12"></path>
                        </svg>
                        <span class="truncate">{{ gymLabel(p.gimnasio) }}</span>
                      </span>
                    </div>
                  }
                </td>

                <!-- Código -->
                <td
                  class="py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center align-top"
                  [ngClass]="menuAbierto() ? 'hidden xl:table-cell' : 'hidden lg:table-cell'"
                >
                  <span class="font-medium">{{ p.codigo }}</span>
                </td>

                <!-- Detalles (solo <lg) -->
                <td class="lg:hidden py-2 px-3 sm:px-4 align-top">
                  <div class="flex flex-col gap-1.5 min-w-0">
                    <div class="flex flex-wrap items-center gap-2">
                      <span class="inline-flex items-center gap-1 rounded-full bg-ra-grayLight/40 px-2 py-0.5 text-[10px] font-semibold text-ra-slate">
                        <span class="text-ra-slate/70">Cod:</span> {{ p.codigo }}
                      </span>

                      <span class="inline-flex items-center gap-1 rounded-full bg-ra-bg/70 px-2 py-0.5 text-[10px] font-semibold text-ra-slate">
                        <span class="text-ra-slate/70">Cant:</span> {{ p.cantidad }}
                      </span>

                      <span class="inline-flex items-center gap-1 rounded-full bg-ra-bg/70 px-2 py-0.5 text-[10px] font-semibold text-ra-slate max-w-full">
                        <span class="text-ra-slate/70">Cat:</span>
                        <span class="truncate">{{ p.categoria.nombre }}</span>
                      </span>
                    </div>

                    <div class="flex flex-wrap items-center gap-2">
                      <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 text-emerald-700 px-2 py-0.5 text-[10px] font-semibold">
                        <span class="text-emerald-700/70">Compra:</span>
                        {{ (+p.precioCompra) | currency:'MXN':'symbol-narrow':'1.2-2' }}
                      </span>

                      <span class="inline-flex items-center gap-1 rounded-full bg-amber-50 text-amber-700 px-2 py-0.5 text-[10px] font-semibold">
                        <span class="text-amber-700/70">Venta:</span>
                        {{ (+p.precioVenta) | currency:'MXN':'symbol-narrow':'1.2-2' }}
                      </span>
                    </div>
                  </div>
                </td>

                <!-- Compra -->
                <td class="hidden lg:table-cell py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center align-top font-medium">
                  {{ (+p.precioCompra) | currency:'MXN':'symbol-narrow':'1.2-2' }}
                </td>

                <!-- Venta -->
                <td class="hidden lg:table-cell py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center align-top font-medium">
                  {{ (+p.precioVenta) | currency:'MXN':'symbol-narrow':'1.2-2' }}
                </td>

                <!-- Cantidad -->
                <td class="hidden lg:table-cell py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center align-top">
                  <span class="font-semibold">{{ p.cantidad }}</span>
                </td>

                <!-- Categoría -->
                <td class="hidden lg:table-cell py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center align-top min-w-0">
                  <span class="truncate inline-block max-w-full" [title]="p.categoria.nombre">{{ p.categoria.nombre }}</span>
                </td>

                <!-- Gimnasio -->
                @if (isAdmin) {
                  <td class="hidden xl:table-cell py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 text-center align-top min-w-0">
                    <span
                      class="inline-flex items-center gap-1 rounded-full bg-[color:var(--color-ra-azul-fuerte)]/10 text-[color:var(--color-ra-azul-fuerte)] px-2 py-0.5 text-[10.5px] xl:text-[11px] 2xl:text-xs font-semibold max-w-full"
                      [title]="gymLabel(p.gimnasio)"
                    >
                      <svg viewBox="0 0 24 24" class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 21h18M6 21V5h6v16M12 9h6v12"></path>
                      </svg>
                      <span class="truncate">{{ gymLabel(p.gimnasio) }}</span>
                    </span>
                  </td>
                }

                <!-- Acciones -->
                <td class="py-2 lg:py-1.5 2xl:py-2.5 px-3 sm:px-4 lg:px-3.5 2xl:px-6 align-top">
                  <div class="flex items-center justify-center gap-1.5">
                    @if (puedeMoverStock) {
  <!-- Entrada -->
  <button
    (click)="abrirEntrada(p)"
    class="
      h-8 w-8 lg:h-7 lg:w-7 2xl:h-8 2xl:w-8
      grid place-items-center rounded-md
      hover:bg-blue-100
      active:scale-[0.98]

    "
    title="Entrada de stock"
  >
    <img
      src="iconos/agregar-negro.svg"
      alt="Entrada"
      class="w-5 h-5 lg:w-4 lg:h-4 2xl:w-5 2xl:h-5"
    />
  </button>

  <!-- Ajuste -->
  <button
    (click)="abrirAjuste(p)"
    class="
      h-8 w-8 lg:h-7 lg:w-7 2xl:h-8 2xl:w-8
      grid place-items-center rounded-md
      hover:bg-amber-100
      active:scale-[0.98]
     
    "
    title="Ajustar stock"
  >
    <img
      src="iconos/actualizar.svg"
      alt="Ajuste"
      class="w-5 h-5 lg:w-4 lg:h-4 2xl:w-5 2xl:h-5"
    />
  </button>
}


                    <button
                      (click)="editar(p)"
                      class="h-8 w-8 lg:h-7 lg:w-7 2xl:h-8 2xl:w-8 grid place-items-center rounded hover:bg-ra-grayLight/40"
                      title="Editar"
                    >
                      <img src="iconos/editar.svg" alt="Editar" class="w-5 h-5 lg:w-4 lg:h-4 2xl:w-5 2xl:h-5" />
                    </button>

                    <button
                      (click)="desactivar(p)"
                      class="h-8 w-8 lg:h-7 lg:w-7 2xl:h-8 2xl:w-8 grid place-items-center rounded hover:bg-ra-grayLight/40"
                      title="Eliminar"
                    >
                      <img src="iconos/eliminar.svg" alt="Eliminar" class="w-5 h-5 lg:w-4 lg:h-4 2xl:w-5 2xl:h-5" />
                    </button>
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Producto -->
@if (mostrarModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50" (click)="cerrarModal()"></div>
    <div class="relative z-10 w-full max-w-2xl mx-4">
      <div class="bg-ra-white rounded-xl2 shadow-card">
        <app-producto-modal
          [producto]="productoEditando"
          (cancelar)="cerrarModal()"
          (guardado)="onGuardado()"
        >
        </app-producto-modal>
      </div>
    </div>
  </div>
}

<!-- Modal Stock -->
@if (mostrarStockModal() && stockProducto) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50" (click)="cerrarStockModal()"></div>
    <div class="relative z-10 w-full max-w-xl mx-4">
      <div class="bg-ra-white rounded-xl2 shadow-card">
        <app-stock-modal
          [producto]="stockProducto"
          [modo]="stockModo"
          (cancelar)="cerrarStockModal()"
          (aplicado)="onStockAplicado()"
        />
      </div>
    </div>
  </div>
}
