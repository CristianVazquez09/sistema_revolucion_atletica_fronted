<!-- Encabezado / acciones -->
<div class="ml-2 md:ml-4 mr-4 md:mr-8 mb-3 flex items-center justify-between">
  <div class="flex items-center gap-3">
    <h1 class="text-2xl font-bold text-ra-slate">Corte de Caja</h1>

    @if (corte?.idCorte != null) {
    <span
      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-ra-slate ring-1 ring-black/10">
      ID: {{ corte?.idCorte }}
    </span>
    }
  </div>

  <div class="flex items-center gap-2">
    <!-- Fondo inicial (solo si no hay corte abierto) -->
    @if (!estaAbierto) {
    <div class="relative w-44">
      <span
        class="pointer-events-none absolute inset-y-0 left-3 grid place-items-center text-gray-500 font-semibold"></span>
      <input type="number" min="0" step="0.01" [(ngModel)]="fondoCajaInicial" class="input-filled pl-7"
        placeholder="Fondo inicial*" />
    </div>
    }

    <button type="button" (click)="abrirCorte()" [disabled]="estaAbierto || cargando" class="btn-green">
      Abrir corte
    </button>
    <button type="button" (click)="cerrarCorte()" [disabled]="!estaAbierto || cargando" class="btn-red">
      Cerrar corte
    </button>
  </div>
</div>

<!-- Estado de carga / error -->
@if (cargando) {
<div class="mx-4 md:mx-8 my-3 summary-box">Cargando…</div>
}
@if (error) {
<div class="mx-4 md:mx-8 my-3 summary-box text-red-700 border-red-300 bg-red-50">
  {{ error }}
</div>
}

<!-- Resumen principal -->
<div class="card">
  <div class="card-header flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="text-lg font-semibold text-ra-slate">Resumen</div>
      @if (corte?.estado) {
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold" [ngClass]="{
            'bg-emerald-100 text-emerald-700': estaAbierto,
            'bg-gray-200 text-gray-700': !estaAbierto
          }">
        {{ corte?.estado }}
      </span>
      }
    </div>

    @if (corte?.idCorte != null) {
    <div class="text-sm text-ra-slate/80">
      ID: <span class="font-semibold">{{ corte?.idCorte }}</span>
    </div>
    }
  </div>

  <div class="px-6 py-6 grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Fechas -->
    <div class="summary-box">
      <div class="font-semibold text-ra-slate mb-2">Apertura</div>
      <div class="text-sm">{{ corte?.apertura | date:'dd/MM/yyyy HH:mm:ss' }}</div>

      <div class="mt-4 font-semibold text-ra-slate mb-2">Cierre</div>
      <div class="text-sm">
        @if (corte?.cierre) {
        {{ corte?.cierre | date:'dd/MM/yyyy HH:mm:ss' }}
        } @else { — }
      </div>
    </div>

    <!-- Totales (del corte; se llenan al cerrar) -->
    <div class="summary-box">
      <div class="font-semibold text-ra-slate mb-2">Totales</div>
      <div class="flex items-center justify-between text-sm py-1">
        <span>Ventas</span>
        <span class="font-medium">
          {{ (corte?.totalVentas ?? 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
        </span>
      </div>
      <div class="flex items-center justify-between text-sm py-1">
        <span>Membresías</span>
        <span class="font-medium">
          {{ (corte?.totalMembresias ?? 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
        </span>
      </div>
      <div class="flex items-center justify-between text-sm py-1">
        <span>Accesorías</span>
        <span class="font-medium">
          {{ (corte?.totalAccesorias ?? 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
        </span>
      </div>
      <div class="mt-2 border-t pt-2 flex items-center justify-between">
        <span class="font-semibold">Total general</span>
        <span class="font-bold text-ra-slate">
          {{ (corte?.totalGeneral ?? 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
        </span>
      </div>
    </div>

    <!-- Estado rápido -->
    <div class="summary-box">
      <div class="font-semibold text-ra-slate mb-2">Estado</div>
      <div class="text-sm">
        @if (corte) {
        <div>El corte está <strong>{{ corte.estado }}</strong>.</div>
        @if (estaAbierto) {
        <div class="mt-2 text-ra-slate/80">Puedes registrar operaciones y ver la previsualización.</div>
        } @else {
        <div class="mt-2 text-ra-slate/80">Corte cerrado. Solo consulta.</div>
        }
        } @else {
        <div class="text-ra-slate/80">Sin información. Abre un corte para comenzar.</div>
        }
      </div>
    </div>
  </div>
</div>

<!-- Panel LIVE (solo si abierto) -->
@if (estaAbierto) {
<div class="card">
  <div class="card-header flex items-center justify-between">
    <div class="text-lg font-semibold text-ra-slate">Previsualización en vivo</div>
    <button class="rcm-btn rcm-btn--blue" (click)="refrescarPreview()">Actualizar</button>
  </div>

  <div class="px-6 py-6 grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="summary-box">
      <div class="font-semibold text-ra-slate mb-1">Fondo inicial</div>
      <div class="text-lg font-bold">
        {{ (preview?.fondoCajaInicial ?? corte?.fondoCajaInicial ?? 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
      </div>
    </div>
    <div class="summary-box">
      <div class="font-semibold text-ra-slate mb-1">Ingresos (Efectivo)</div>
      <div class="text-lg font-bold">
        {{ (preview?.ingresosEfectivo ?? 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
      </div>
    </div>
    <div class="summary-box">
      <div class="font-semibold text-ra-slate mb-1">Salidas de efectivo</div>
      <div class="text-lg font-bold">
        {{ (preview?.totalSalidasEfectivo ?? 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
      </div>
    </div>
    <div class="summary-box">
      <div class="font-semibold text-ra-slate mb-1">Efectivo esperado</div>
      <div class="text-lg font-bold">
        {{ (preview?.efectivoEsperado ?? 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
      </div>
    </div>
  </div>

  <!-- Tipos de ingreso -->
  <div class="px-6 pb-4">
    <div class="font-semibold text-ra-slate mb-2">Tipos de ingreso</div>
    <div class="overflow-x-auto">
      <table class="w-full min-w-[640px] text-[13px]">
        <thead class="bg-ra-grayLight/40">
          <tr class="text-ra-slate">
            <th class="py-3 px-4 text-left  font-semibold uppercase">Tipo</th>
            <th class="py-3 px-4 text-center font-semibold uppercase">Operaciones</th>
            <th class="py-3 px-4 text-right font-semibold uppercase">Total</th>
          </tr>
        </thead>
        <tbody>
          @if (!preview?.tiposDeIngreso?.length) {
          <tr>
            <td colspan="3" class="py-4 px-4 text-center text-ra-slate">Sin datos.</td>
          </tr>
          } @else {
          @for (t of preview?.tiposDeIngreso; track $index) {
          <tr class="border-t">
            <td class="py-2 px-4">{{ t.tipo }}</td>
            <td class="py-2 px-4 text-center">{{ t.operaciones }}</td>
            <td class="py-2 px-4 text-right">{{ t.total | currency:'MXN':'symbol-narrow':'1.2-2' }}</td>
          </tr>
          }
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Formas de pago (agrupadas por tipo, LIVE) -->
  <div class="px-6 pb-6">
    <div class="font-semibold text-ra-slate mb-2">Formas de pago (todas las fuentes)</div>
    <div class="overflow-x-auto">
      <table class="w-full min-w-[520px] text-[13px]">
        <thead class="bg-ra-grayLight/40">
          <tr class="text-ra-slate">
            <th class="py-3 px-4 text-left  font-semibold uppercase">Forma de pago</th>
            <th class="py-3 px-4 text-center font-semibold uppercase">Operaciones</th>
            <th class="py-3 px-4 text-right font-semibold uppercase">Total</th>
          </tr>
        </thead>
        <tbody>
          @if (!formasPagoAgrupadasPreview.length) {
          <tr>
            <td colspan="3" class="py-4 px-4 text-center text-ra-slate">Sin datos.</td>
          </tr>
          } @else {
          @for (f of formasPagoAgrupadasPreview; track $index) {
          <tr class="border-t">
            <td class="py-2 px-4">{{ f.tipo }}</td>
            <td class="py-2 px-4 text-center">{{ f.operaciones }}</td>
            <td class="py-2 px-4 text-right">{{ f.total | currency:'MXN':'symbol-narrow':'1.2-2' }}</td>
          </tr>
          }
          }
        </tbody>
      </table>
    </div>
  </div>


</div>
}

<!-- Salidas de efectivo (alta + listado con labels "filled") -->
@if (estaAbierto) {
<div class="card min-h-0">
  <div class="card-header text-lg font-semibold text-ra-slate">Salidas de efectivo</div>

  <!-- Alta -->
  <div class="px-6 pb-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
    <!-- Concepto -->
    <div class="relative">
      <input class="input-filled pl-4" [(ngModel)]="salidaConcepto" placeholder="Concepto*" />
    </div>

    <!-- Monto -->
    <div class="relative">
      <input type="number" min="0" step="0.01" class="input-filled pl-4" [(ngModel)]="salidaMonto" placeholder="0.00" />
    </div>

    <button class="btn-primary-red" (click)="registrarSalida()" [disabled]="cargando">
      Registrar salida
    </button>

  </div>

  <!-- Lista -->
  <div class="px-6 pb-6">
    <div class="overflow-x-auto">
      <div class="max-h-[60vh] md:max-h-[50vh] overflow-y-auto rounded-lg ring-1 ring-black/5">
        <table class="w-full min-w-[640px] text-[13px]">
          <thead class="sticky top-0 bg-ra-grayLight/40 z-10">
            <tr class="text-ra-slate">
              <th class="py-3 px-4 text-left  font-semibold uppercase">Fecha</th>
              <th class="py-3 px-4 text-left  font-semibold uppercase">Concepto</th>
              <th class="py-3 px-4 text-right font-semibold uppercase">Monto</th>
            </tr>
          </thead>
          <tbody>
            @if (!salidas.length) {
            <tr>
              <td colspan="3" class="py-4 px-4 text-center text-ra-slate">
                Sin salidas registradas.
              </td>
            </tr>
            } @else {
            @for (s of salidas; track $index) {
            <tr class="border-t">
              <td class="py-2 px-4">{{ s.fecha | date:'dd/MM/yyyy HH:mm' }}</td>
              <td class="py-2 px-4">{{ s.concepto }}</td>
              <td class="py-2 px-4 text-right">
                {{ s.monto | currency:'MXN':'symbol-narrow':'1.2-2' }}
              </td>
            </tr>
            }
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
}

<!-- Cierre: captura de efectivo entregado y conteo -->
@if (estaAbierto) {
<div class="card">
  <div class="card-header text-lg font-semibold text-ra-slate">Cerrar corte</div>
  <div class="px-6 pb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="relative">
      <input type="number" min="0" step="0.01" class="input-filled pl-4" [(ngModel)]="efectivoEntregado"
        placeholder="Efectivo entregado*" />
    </div>
    <div class="relative">
      <input type="number" min="0" step="0.01" class="input-filled pl-4" [(ngModel)]="efectivoEnCajaConteo"
        placeholder="Efectivo en caja (conteo)*" />
    </div>
    <div class="flex items-end">
      <button class="btn-red" (click)="cerrarCorte()">Confirmar cierre</button>
    </div>
  </div>
</div>
}

<!-- Desglose por pagos (tabla — del CORTE, útil al cerrar) -->
<div class="card">
  <div class="card-header">
    <div class="text-lg font-semibold text-ra-slate">Desglose por Origen y Tipo de pago (Corte)</div>
  </div>

  <div class="overflow-x-auto">
    <div class="max-h-[calc(100vh-260px)] overflow-auto">
      <table class="w-full table-fixed min-w-[900px] text-[13px]">
        <colgroup>
          <col class="w-[40%]">
          <col class="w-[25%]">
          <col class="w-[15%]">
          <col class="w-[20%]">
        </colgroup>
        <thead class="sticky top-0 bg-ra-grayLight/40 z-10">
          <tr class="text-ra-slate">
            <th class="py-3 px-4 text-left  font-semibold uppercase">Origen</th>
            <th class="py-3 px-4 text-left  font-semibold uppercase">Tipo de pago</th>
            <th class="py-3 px-4 text-center font-semibold uppercase">Operaciones</th>
            <th class="py-3 px-4 text-right font-semibold uppercase">Total</th>
          </tr>
        </thead>
        <tbody>
          @if (!corte?.desgloses?.length) {
          <tr>
            <td colspan="4" class="py-6 px-4 text-center text-ra-slate">Sin datos para mostrar.</td>
          </tr>
          } @else {
          @for (d of corte?.desgloses; track $index) {
          <tr class="border-t border-ra-grayLight/60 hover:bg-ra-bg">
            <td class="py-3 px-4 truncate">{{ d.origen }}</td>
            <td class="py-3 px-4 truncate">{{ d.tipoPago }}</td>
            <td class="py-3 px-4 text-center">{{ d.operaciones }}</td>
            <td class="py-3 px-4 text-right">
              {{ d.total | currency:'MXN':'symbol-narrow':'1.2-2' }}
            </td>
          </tr>
          }
          }
        </tbody>
      </table>
    </div>
  </div>
</div>