<!-- src/app/pages/inventario/inventario.html -->

<!-- Barra superior -->
<div class="mx-4 md:mx-10 mb-4 flex flex-col xl:flex-row xl:items-center xl:justify-between gap-3">
  <!-- Izquierda: título + estado -->
  <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 min-w-0">
    <div class="text-base sm:text-lg xl:text-xl font-semibold text-ra-slate shrink-0">
      Inventario
    </div>

    <!-- Estado del turno (envuelve bien en pantallas pequeñas) -->
    <div class="flex flex-wrap items-center gap-2 min-w-0">
      <span
        class="inline-flex items-center gap-2 rounded-full px-2.5 py-1 text-[10px] sm:text-[11px] font-semibold ring-1 max-w-full"
        [ngClass]="estadoClase()"
        [title]="cerrado() ? ('Cerrado por ' + (cerradoPor() || '—')) : 'Turno abierto'"
      >
        <span
          class="h-2 w-2 rounded-full shrink-0"
          [ngClass]="cerrado() ? 'bg-emerald-500' : 'bg-amber-500'"
        ></span>

        <span class="truncate max-w-[22ch] sm:max-w-none">
          {{ estadoLabel() }}
        </span>

        @if (cerrado() && fechaCierre()) {
          <!-- En XS oculto, en SM+ visible (para que no se amontone) -->
          <span class="hidden sm:inline text-[10px] font-medium opacity-80">
            ({{ fechaHoraMin(fechaCierre()) }})
          </span>
        }
      </span>

      @if (cerrado() && cerradoPor()) {
        <!-- De MD en adelante para no saturar en pantallas pequeñas -->
        <span class="hidden md:inline text-xs text-ra-slate/70 truncate max-w-[30ch]">
          por {{ cerradoPor() }}
        </span>
      }
    </div>
  </div>

  <!-- Derecha: acciones -->
  <div class="flex items-center justify-end gap-2 w-full xl:w-auto">
    <button
      (click)="refrescar()"
      class="h-9 w-9 grid place-items-center rounded-lg hover:bg-ra-grayLight/40 shrink-0"
      title="Refrescar"
    >
      <img src="iconos/actualizar.svg" class="w-5 h-5" alt="Refrescar" />
    </button>

    @if (!cerrado()) {
      <button
        (click)="cerrarTurno()"
        class="inline-flex items-center justify-center rounded-md bg-ra-rojo-oscuro text-white hover:bg-red-700 shadow-card
               px-3 py-2 text-xs sm:text-sm whitespace-nowrap h-9"
        title="Cerrar turno"
      >
        Cerrar turno
      </button>
    }
  </div>
</div>

<!-- Filtros (responsivo abajo de XL) -->
<div class="mx-4 md:mx-10 mb-4 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-12 gap-3">
  <div class="sm:col-span-1 xl:col-span-3">
    <label class="block text-xs font-semibold text-ra-slate mb-1">Fecha</label>
    <input
      type="date"
      class="input-filled w-full"
      [max]="hoyMax"
      [ngModel]="fecha()"
      (ngModelChange)="onFechaChange($event)"
    />
  </div>

  <div class="sm:col-span-1 xl:col-span-3">
    <label class="block text-xs font-semibold text-ra-slate mb-1">Turno</label>
    <select class="input-filled w-full" [ngModel]="turno()" (ngModelChange)="onTurnoChange($event)">
      @for (t of turnosDisponibles(); track t) {
        <option [ngValue]="t">{{ turnoLabel(t) }}</option>
      }
    </select>

    @if (bloqueoTardeMsg()) {
      <div class="mt-1 text-[11px] text-amber-700 break-words">{{ bloqueoTardeMsg() }}</div>
    }
  </div>

  @if (isAdmin) {
    <div class="sm:col-span-1 xl:col-span-3">
      <label class="block text-xs font-semibold text-ra-slate mb-1">Gimnasio</label>
      <select class="input-filled w-full" [ngModel]="gimnasioId()" (ngModelChange)="onGymChange($event)">
        @if (cargandoGimnasios) {
          <option [ngValue]="null" disabled>Cargando gimnasios…</option>
        } @else {
          @for (g of gimnasios; track g.idGimnasio) {
            <option [ngValue]="g.idGimnasio">{{ g.nombre }}</option>
          }
        }
      </select>
    </div>
  }

  <!-- Buscar: en sm ocupa 2 columnas para que no quede apretado -->
  <div class="sm:col-span-2 xl:col-span-3">
    <label class="block text-xs font-semibold text-ra-slate mb-1">Buscar</label>
    <input
      type="text"
      class="input-filled w-full"
      placeholder="Nombre, código o ID"
      [ngModel]="termino()"
      (ngModelChange)="termino.set($event)"
    />
  </div>
</div>

<!-- ✅ Quitados: Vendidos/Entradas/Ajustes (totales rápidos) -->

<!-- Tabla -->
<div class="shadow-card rounded-xl2 mx-4 md:mx-10 bg-ra-white ring-1 ring-black/10 overflow-hidden">
  <div class="overflow-x-hidden xl:overflow-x-auto">
    <div class="overflow-y-auto max-h-[calc(100dvh-260px)] min-h-[320px] xl:max-h-[calc(100dvh-280px)] 2xl:max-h-[calc(100dvh-300px)]">
      <table class="w-full min-w-0 table-auto 2xl:table-fixed text-[11px] sm:text-[12px] lg:text-[11px] 2xl:text-[12px] 2xl:min-w-[980px]">
        <colgroup>
          <col class="w-[70px]" />
          <col class="w-auto 2xl:w-[320px]" />
          <col class="hidden lg:table-column lg:w-[140px]" />
          <col class="w-[110px]" /> <!-- Inicio -->
          <col class="w-[110px]" /> <!-- Entradas -->
          <col class="w-[110px]" /> <!-- Ajustes -->
          <col class="w-[110px]" /> <!-- Vendidos -->
          <col class="w-[110px]" /> <!-- Fin -->
        </colgroup>

        <thead class="sticky top-0 bg-ra-grayLight/40 z-10 backdrop-blur">
          <tr class="text-ra-slate">
            <th class="py-2 px-4 text-center font-semibold uppercase text-[10px] sm:text-[11px]">ID</th>
            <th class="py-2 px-4 text-left font-semibold uppercase text-[10px] sm:text-[11px]">Producto</th>
            <th class="hidden lg:table-cell py-2 px-4 text-center font-semibold uppercase text-[10px] sm:text-[11px]">Código</th>

            <th class="py-2 px-4 text-center font-semibold uppercase text-[10px] sm:text-[11px]">Inicio</th>
            <th class="py-2 px-4 text-center font-semibold uppercase text-[10px] sm:text-[11px]">Entradas</th>
            <th class="py-2 px-4 text-center font-semibold uppercase text-[10px] sm:text-[11px]">Ajustes</th>
            <th class="py-2 px-4 text-center font-semibold uppercase text-[10px] sm:text-[11px]">Vendidos</th>
            <th class="py-2 px-4 text-center font-semibold uppercase text-[10px] sm:text-[11px]">Fin</th>
          </tr>
        </thead>

        <tbody>
          @if (loading()) {
            <tr><td [attr.colspan]="99" class="py-6 px-6 text-center text-ra-slate">Cargando…</td></tr>
          } @else if (filasFiltradas().length === 0) {
            <tr><td [attr.colspan]="99" class="py-6 px-6 text-center text-ra-slate">Sin resultados.</td></tr>
          } @else {
            @for (x of filasFiltradas(); track x.idProducto) {
              <tr class="border-t border-ra-grayLight/60 hover:bg-ra-bg">
                <td class="py-2 px-4 text-center">
                  <span class="inline-block min-w-[3ch] rounded-md border border-gray-200 bg-gray-100 px-2 py-0.5 text-[10px] font-mono text-gray-700">
                    {{ x.idProducto }}
                  </span>
                </td>

                <td class="py-2 px-4 text-left min-w-0">
                  <div class="font-medium truncate" [title]="x.nombre">{{ x.nombre }}</div>
                  <div class="lg:hidden mt-1">
                    <span class="inline-flex items-center gap-1 rounded-full bg-ra-grayLight/40 px-2 py-0.5 text-[10px] font-semibold text-ra-slate">
                      <span class="text-ra-slate/70">Cod:</span> {{ x.codigo || '—' }}
                    </span>
                  </div>
                </td>

                <td class="hidden lg:table-cell py-2 px-4 text-center">
                  <span class="font-medium">{{ x.codigo || '—' }}</span>
                </td>

                <td class="py-2 px-4 text-center font-semibold">{{ x.stockInicio }}</td>
                <td class="py-2 px-4 text-center">{{ x.entradas }}</td>
                <td class="py-2 px-4 text-center">{{ x.ajustes }}</td>
                <td class="py-2 px-4 text-center">{{ x.vendidos }}</td>
                <td class="py-2 px-4 text-center font-semibold text-ra-slate">{{ x.stockFin }}</td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  </div>
</div>
