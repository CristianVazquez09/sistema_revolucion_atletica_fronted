<!-- Barra superior (estilo Membresías) -->
<div class="mx-4 md:mx-10 mb-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
  <div class="text-xl font-semibold text-ra-slate">Ventas</div>

  <div class="flex flex-wrap items-center gap-2">
    <!-- Buscador por ID -->
    <div class="flex items-center gap-2">
      <label class="hidden md:inline text-sm text-ra-slate/80">Venta ID</label>
      <input type="number" min="1"
             class="w-[150px] rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
             placeholder="#"
             [(ngModel)]="buscarId"
             (keyup.enter)="buscar()">
      <button type="button"
              class="px-3 py-2 rounded-md bg-[#0B2C4A] text-white hover:brightness-110 shadow-card text-sm"
              (click)="buscar()">Buscar</button>
      <button type="button"
              class="px-3 py-2 rounded-md border text-sm"
              [disabled]="!buscandoPorId && !buscarId"
              (click)="limpiarBusqueda()">Limpiar</button>
    </div>

    <div class="w-px h-6 mx-2 bg-gray-200 hidden md:block"></div>

    <!-- Orden/size -->
    <span class="hidden md:inline text-sm text-ra-slate/80">Ordenar por</span>
    <select class="rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
            [(ngModel)]="sortCampo" (change)="go(1)" [disabled]="buscandoPorId">
      <option [ngValue]="'fecha'">Fecha</option>
      <option [ngValue]="'idVenta'">ID</option>
      <option [ngValue]="'total'">Total</option>
    </select>

    <select class="rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
            [(ngModel)]="sortDir" (change)="go(1)" [disabled]="buscandoPorId">
      <option [ngValue]="'desc'">Desc</option>
      <option [ngValue]="'asc'">Asc</option>
    </select>

    <label class="text-sm text-ra-slate/80 ml-2">Por página</label>
    <select class="rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
            [(ngModel)]="sizeSel" (change)="go(1)" [disabled]="buscandoPorId">
      <option [ngValue]="10">10</option>
      <option [ngValue]="25">25</option>
      <option [ngValue]="50">50</option>
    </select>

    <button type="button"
            class="px-4 py-2 rounded-md bg-[#0B2C4A] text-white hover:brightness-110 shadow-card text-sm"
            (click)="go(1)" [disabled]="buscandoPorId">
      Actualizar
    </button>
  </div>
</div>

<!-- Tabla -->
<div class="shadow-card rounded-xl2 overflow-hidden mx-4 md:mx-10 bg-ra-white">
  <table class="w-full table-fixed text-sm">
    <colgroup>
      <col class="w-[8%]">
      <col class="w-[18%]">
      <col class="w-[20%]">
      @if (esAdmin) { <col class="w-[18%]"> }
      <col class="w-[24%]">
      <col class="w-[12%]">
      <col class="w-[10%]">
    </colgroup>

    <thead>
      <tr class="bg-ra-grayLight/40">
        <th class="py-4 px-6 text-center text-ra-slate font-semibold uppercase">ID</th>
        <th class="py-4 px-6 text-center text-ra-slate font-semibold uppercase">Fecha</th>
        <th class="py-4 px-6 text-center text-ra-slate font-semibold uppercase">Usuario</th>
        @if (esAdmin) {
          <th class="py-4 px-6 text-center text-ra-slate font-semibold uppercase">Gimnasio</th>
        }
        <th class="py-4 px-6 text-center text-ra-slate font-semibold uppercase">Pagos</th>
        <th class="py-4 px-6 text-center text-ra-slate font-semibold uppercase">Total</th>
        <th class="py-4 px-6 text-center text-ra-slate font-semibold uppercase">Acciones</th>
      </tr>
    </thead>

    <tbody>
      @if (cargando) {
        <tr><td [attr.colspan]="esAdmin ? 7 : 6" class="py-6 px-6 text-center text-ra-slate">Cargando…</td></tr>
      } @else if (error) {
        <tr><td [attr.colspan]="esAdmin ? 7 : 6" class="py-6 px-6 text-center text-red-600">{{ error }}</td></tr>
      } @else if (!rows.length) {
        <tr><td [attr.colspan]="esAdmin ? 7 : 6" class="py-6 px-6 text-center text-ra-slate">Sin resultados.</td></tr>
      } @else {
        @for (v of rows; track trackById($index, v)) {
          <tr class="border-t border-ra-grayLight/60 hover:bg-ra-bg text-center">
            <td class="py-3 px-6 font-medium">
              <span class="inline-block min-w-[3ch] rounded-md border border-gray-200 bg-gray-100 px-2 py-0.5 text-xs font-mono text-gray-700">
                {{ v.idVenta }}
              </span>
            </td>
            <td class="py-3 px-6 text-xs md:text-sm">
              {{ v.fecha | date:'dd/MM/yyyy HH:mm:ss' }}
            </td>
            <td class="py-3 px-6 truncate">{{ v.usuario?.nombreUsuario || '—' }}</td>

            @if (esAdmin) {
              <td class="py-3 px-6">
                <span class="inline-flex items-center gap-1 rounded-full bg-[color:var(--color-ra-azul-fuerte)]/10 text-[color:var(--color-ra-azul-fuerte)] px-2 py-0.5 text-xs">
                  <svg viewBox="0 0 24 24" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 21h18M6 21V5h6v16M12 9h6v12"></path>
                  </svg>
                  {{ gymDeVenta(v) }}
                </span>
              </td>
            }

            <td class="py-3 px-6 text-xs md:text-sm truncate" [title]="pagosChip(v)">{{ pagosChip(v) }}</td>
            <td class="py-3 px-6 font-semibold">{{ v.total | currency:'MXN':'symbol-narrow':'1.2-2' }}</td>

            <td class="py-2 px-3">
              <div class="flex items-center justify-center gap-1">
                <button (click)="ver(v)" class="p-2 rounded hover:bg-ra-grayLight/40" title="Ver">
                  <img src="iconos/historial.svg" alt="Ver" class="w-5 h-5" />
                </button>
                <button (click)="eliminar(v)" class="p-2 rounded hover:bg-ra-grayLight/40" title="Eliminar">
                  <img src="iconos/eliminar.svg" alt="Eliminar" class="w-5 h-5" />
                </button>
              </div>
            </td>
          </tr>
        }
      }
    </tbody>
  </table>
</div>

<!-- Paginación -->
<div class="mx-4 md:mx-10 mt-3 mb-2 flex items-center justify-between text-sm">
  <div>
    Página <strong>{{ pageUI }}</strong> de <strong>{{ page.totalPages || 1 }}</strong>
    <span class="ml-2 text-ra-slate/70">({{ page.totalElements || 0 }} registros)</span>
    @if (buscandoPorId) {
      <span class="ml-3 inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-amber-100 text-amber-800">
        Modo búsqueda por ID
      </span>
    }
  </div>
  <div class="flex items-center gap-2">
    <button class="rounded-md border px-3 py-1.5 bg-white disabled:opacity-50"
            [disabled]="!puedePrev || buscandoPorId" (click)="prev()">Anterior</button>
    <button class="rounded-md border px-3 py-1.5 bg-white disabled:opacity-50"
            [disabled]="!puedeNext || buscandoPorId" (click)="next()">Siguiente</button>
  </div>
</div>

<!-- Modal -->
@if (mostrarModal() && idVer !== null) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" (click)="cerrarModal()"></div>
    <div class="relative z-10 w-full max-w-[900px] mx-4">
      <app-ventas-admin-modal
        [idVenta]="idVer!"
        (cancelar)="cerrarModal()"
        (guardado)="onGuardado($event)">
      </app-ventas-admin-modal>
    </div>
  </div>
}
