<div class="mx-auto w-full rounded-2xl bg-white shadow-2xl ring-1 ring-black/5 overflow-hidden">
  <!-- Header -->
  <div class="flex items-start justify-between px-4 sm:px-6 pt-5">
    <div class="min-w-0">
      <h2 class="text-[18px] sm:text-[20px] font-bold text-ra-slate leading-none">
        {{ titulo() }}
      </h2>

      @if (esEdicion()) {
        <p class="mt-1 text-[12px] text-ra-slate/70">
          Administra aquí los paquetes vinculados y también puedes renovar la promoción.
        </p>
      }
    </div>

    <button
      class="w-8 h-8 grid place-items-center rounded-full bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300"
      (click)="cerrar()"
      [disabled]="guardando() || gestionPaquetesBusy()"
      aria-label="Cerrar"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <div class="max-h-[82vh] overflow-y-auto">
    <form class="px-4 sm:px-6 pb-6 pt-4 space-y-4" (ngSubmit)="guardar()" [formGroup]="form">

      @if (isAdmin) {
        <div>
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Gimnasio destino</label>
          <select
            formControlName="gimnasioId"
            class="w-full rounded-xl border border-gray-200 bg-gray-100 text-gray-900 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green focus:border-transparent"
            [disabled]="guardando() || gestionPaquetesBusy()"
          >
            <option [ngValue]="null" disabled>Selecciona un gimnasio</option>
            @for (g of gimnasios; track g.idGimnasio) {
              <option [ngValue]="g.idGimnasio">{{ g.nombre }}</option>
            }
          </select>
        </div>
      }

      <div>
        <label class="block text-sm font-semibold text-ra-slate mb-1.5">Nombre</label>
        <input
          type="text"
          formControlName="nombre"
          class="w-full rounded-xl border border-gray-200 bg-gray-100 text-gray-900 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green focus:border-transparent"
          [disabled]="guardando() || gestionPaquetesBusy()"
        />
      </div>

      <div>
        <label class="block text-sm font-semibold text-ra-slate mb-1.5">Descripción</label>
        <textarea
          rows="2"
          formControlName="descripcion"
          class="w-full rounded-xl border border-gray-200 bg-gray-100 text-gray-900 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green focus:border-transparent"
          [disabled]="guardando() || gestionPaquetesBusy()"
        ></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Fecha inicio</label>
          <input type="date" formControlName="fechaInicio"
            class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green"
            [disabled]="guardando() || gestionPaquetesBusy()" />
        </div>

        <div>
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Fecha fin</label>
          <input type="date" formControlName="fechaFin"
            class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green"
            [disabled]="guardando() || gestionPaquetesBusy()" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold text-ra-slate mb-1.5">Tipo</label>
        <select
          formControlName="tipo"
          class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green"
          [disabled]="guardando() || gestionPaquetesBusy()"
        >
          <option [ngValue]="TipoPromocion.DESCUENTO_PORCENTAJE">{{ labelTipo(TipoPromocion.DESCUENTO_PORCENTAJE) }}</option>
          <option [ngValue]="TipoPromocion.DESCUENTO_MONTO">{{ labelTipo(TipoPromocion.DESCUENTO_MONTO) }}</option>
          <option [ngValue]="TipoPromocion.MESES_GRATIS">{{ labelTipo(TipoPromocion.MESES_GRATIS) }}</option>
        </select>
      </div>

      @if (mostrarPorcentaje()) {
        <div>
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Descuento (%)</label>
          <input type="number" step="0.01" formControlName="descuentoPorcentaje"
            class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green"
            [disabled]="guardando() || gestionPaquetesBusy()" />
        </div>
      }

      @if (mostrarMonto()) {
        <div>
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Descuento ($)</label>
          <input type="number" step="0.01" formControlName="descuentoMonto"
            class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green"
            [disabled]="guardando() || gestionPaquetesBusy()" />
        </div>
      }

      @if (mostrarMeses()) {
        <div>
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Meses gratis</label>
          <input type="number" step="1" formControlName="mesesGratis"
            class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green"
            [disabled]="guardando() || gestionPaquetesBusy()" />
        </div>
      }

      <div class="flex flex-col gap-2">
        <label class="inline-flex items-center gap-2 text-sm text-ra-slate">
          <input type="checkbox" formControlName="soloNuevos" class="h-4 w-4" [disabled]="guardando() || gestionPaquetesBusy()" />
          <span>Solo nuevos ingresos</span>
        </label>

        <label class="inline-flex items-center gap-2 text-sm text-ra-slate">
          <input type="checkbox" formControlName="sinCostoInscripcion" class="h-4 w-4" [disabled]="guardando() || gestionPaquetesBusy()" />
          <span>Sin costo de inscripción</span>
        </label>
      </div>

      <!-- Paquetes vinculados -->
      <div class="rounded-2xl border border-gray-200 bg-gray-50 p-4">
        <div class="text-sm font-bold text-ra-slate">Paquetes vinculados</div>
        <div class="text-xs text-ra-slate/70">Agrega o quita paquetes de esta promoción.</div>

        <div class="mt-3">
          @if ((paquetesVinculados().length) === 0) {
            <div class="text-sm text-ra-slate/70">Sin paquetes vinculados.</div>
          } @else {
            <div class="flex flex-wrap gap-2">
              @for (p of paquetesVinculados(); track paqTrack($index, p)) {
                <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white ring-1 ring-black/10 text-sm">
                  <span class="font-semibold text-ra-slate truncate max-w-[260px]" [title]="paqNombre(p)">
                    {{ paqNombre(p) }}
                  </span>

                  <button
                    type="button"
                    class="w-6 h-6 grid place-items-center rounded-full bg-red-600 text-white hover:bg-red-700 disabled:opacity-60"
                    (click)="quitarPaquete(p)"
                    [disabled]="guardando() || gestionPaquetesBusy()"
                    title="Quitar paquete"
                  >
                    ✕
                  </button>
                </span>
              }
            </div>
          }
        </div>

        <!-- Agregar paquete -->
        <div class="mt-4 grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2 items-end">
          <div>
            <label class="block text-sm font-semibold text-ra-slate mb-1.5">Agregar paquete</label>

            <select
              formControlName="paqueteAddId"
              class="w-full rounded-xl border border-gray-200 bg-gray-100 px-4 py-3 shadow-inner focus:outline-none focus:ring-2 focus:ring-ra-green"
              [disabled]="guardando() || gestionPaquetesBusy()"
            >
              <option [ngValue]="null">Selecciona un paquete</option>
              @for (p of paquetesDisponiblesParaAgregar(); track paqTrack($index, p)) {
                <option [ngValue]="paqId(p)">{{ paqueteOptionLabel(p) }}</option>
              }
            </select>

            @if (isAdmin) {
              <p class="text-xs text-ra-slate/70 mt-1">
                Como ADMIN, solo se muestran paquetes del gimnasio seleccionado.
              </p>
            }
          </div>

          <button
            type="button"
            class="px-5 py-3 rounded-xl bg-[#0B2C4A] text-white hover:bg-[#0A2540] shadow-md disabled:opacity-60"
            (click)="agregarPaquete()"
            [disabled]="guardando() || gestionPaquetesBusy()"
          >
            {{ gestionPaquetesBusy() ? 'Procesando…' : 'Agregar' }}
          </button>
        </div>
      </div>

      <!-- Footer -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-end gap-2 pt-2">
        <button
          type="button"
          (click)="cerrar()"
          class="px-4 py-2 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100"
          [disabled]="guardando() || gestionPaquetesBusy()"
        >
          Cancelar
        </button>

        @if (esEdicion()) {
          <button
            type="button"
            (click)="renovar()"
            [disabled]="guardando() || gestionPaquetesBusy()"
            class="px-4 py-2 rounded-full border border-amber-300 text-amber-800 hover:bg-amber-50 disabled:opacity-60"
            title="Crea una nueva promoción con fechas desde hoy"
          >
            Renovar promoción
          </button>
        }

        <button
          type="submit"
          [disabled]="guardando() || gestionPaquetesBusy()"
          class="px-5 py-2.5 rounded-full bg-[#0B2C4A] text-white hover:bg-[#0A2540] shadow-md disabled:opacity-60"
        >
          {{ guardando() ? 'Guardando…' : 'Guardar' }}
        </button>
      </div>

    </form>
  </div>
</div>
