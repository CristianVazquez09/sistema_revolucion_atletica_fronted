<div class="mx-auto w-full max-w-4xl rounded-2xl bg-white shadow-2xl ring-1 ring-black/5">
  <!-- Header -->
  <div class="flex items-start justify-between px-4 sm:px-6 pt-4 sm:pt-5">
    <h2 class="text-[18px] sm:text-[20px] font-bold text-ra-slate leading-none">
      Membresía #{{ data?.folio || '—' }}
    </h2>

    <button
      class="w-8 h-8 grid place-items-center rounded-full bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300"
      (click)="cancelar.emit()"
      aria-label="Cerrar">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>

  <!-- Body (scroll en pantallas bajas) -->
  <div class="px-4 sm:px-6 pb-5 sm:pb-6 pt-3 sm:pt-4 space-y-4 sm:space-y-5 max-h-[calc(100vh-140px)] overflow-auto">
    @if (cargando) {
      <div class="text-sm text-ra-slate">Cargando…</div>
    } @else if (error) {
      <div class="text-sm text-red-600">{{ error }}</div>
    } @else if (data) {

      <!-- Socio / Paquete actual -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
        <div class="text-sm">
          <div class="font-semibold text-ra-slate/90">Socio</div>
          <div class="text-ra-slate break-words">
            {{ data.socio.nombre }} {{ data.socio.apellido }} (ID: {{ data.socio.idSocio }})
          </div>
        </div>

        <div class="text-sm">
          <div class="font-semibold text-ra-slate/90">Paquete actual</div>
          <div class="text-ra-slate break-words">
            #{{ data.paquete.idPaquete }} — {{ data.paquete.nombre }} ·
            Precio {{ (data.paquete.precio || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }},
            Inscripción {{ (data.paquete.costoInscripcion || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
          </div>
        </div>
      </div>

      <!-- Cambiar paquete (lista) -->
      <div class="rounded-xl2 bg-ra-white shadow-card ring-1 ring-black/10 p-3 sm:p-4">
        <div class="text-sm font-semibold text-ra-slate mb-2">Cambiar paquete (opcional)</div>

        <div class="flex flex-col gap-2">
          <label class="block text-sm font-semibold text-ra-slate">Selecciona un paquete</label>

          <select
            class="w-full lg:w-[520px] rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
            [ngModel]="paqueteNuevoId ?? 0"
            (ngModelChange)="onSeleccionPaqueteNuevo($event ? (+$event || null) : null)">
            <option [ngValue]="0">— Mantener paquete actual (#{{ data.paquete.idPaquete }} — {{ data.paquete.nombre }}) —</option>
            @for (p of listaPaquetes; track p.idPaquete) {
              <option [ngValue]="p.idPaquete">
                #{{ p.idPaquete }} — {{ p.nombre }}
                ({{ (p.precio || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }} + {{ (p.costoInscripcion || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }} inscripción)
              </option>
            }
          </select>

          @if (cargandoListaPaquetes) {
            <div class="text-xs text-ra-slate/70">Cargando paquetes…</div>
          } @else if (paqueteNuevo) {
            <div class="text-xs text-ra-slate/80">
              Nuevo paquete seleccionado: <strong>{{ paqueteNuevo.nombre }}</strong>
              ({{ (paqueteNuevo.precio || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }} + {{ (paqueteNuevo.costoInscripcion || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }} inscripción)
            </div>
          }
        </div>
      </div>

      <!-- Fechas y Descuento -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
        <div>
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Fecha inicio</label>
          <input
            type="date"
            class="w-full rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
            [value]="fechaInicio()"
            (input)="fechaInicio.set($any($event.target).value || '')">
        </div>

        <div>
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Fecha fin</label>
          <input
            type="date"
            class="w-full rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
            [value]="fechaFin()"
            (input)="fechaFin.set($any($event.target).value || '')">
        </div>

        <div class="sm:col-span-2 lg:col-span-1">
          <label class="block text-sm font-semibold text-ra-slate mb-1.5">Descuento</label>
          <input
            type="number"
            min="0"
            step="0.01"
            class="w-full rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
            [value]="descuento()"
            (input)="descuento.set(($any($event.target).valueAsNumber ?? 0) || 0)">
        </div>
      </div>

      <!-- Pagos + Resumen -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mt-1">
        <!-- Pagos -->
        <div class="rounded-xl2 bg-ra-white shadow-card ring-1 ring-black/10 p-3 sm:p-4">
          <div class="text-sm font-semibold text-ra-slate mb-2">Pagos</div>

          <div class="flex flex-col gap-3">
            <!-- EFECTIVO -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <span class="inline-flex w-fit items-center gap-1 rounded-full bg-emerald-100 text-emerald-800 px-2 py-0.5 text-xs">
                EFECTIVO
              </span>

              <input
                type="number"
                min="0"
                step="0.01"
                class="w-full sm:w-[180px] lg:w-[200px] rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
                [value]="efectivo()"
                (input)="efectivo.set(($any($event.target).valueAsNumber ?? 0) || 0)" />
            </div>

            <!-- TARJETA -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <span class="inline-flex w-fit items-center gap-1 rounded-full bg-blue-100 text-blue-800 px-2 py-0.5 text-xs">
                TARJETA
              </span>

              <input
                type="number"
                min="0"
                step="0.01"
                class="w-full sm:w-[180px] lg:w-[200px] rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
                [value]="tarjeta()"
                (input)="tarjeta.set(($any($event.target).valueAsNumber ?? 0) || 0)" />
            </div>

            <!-- TRANSFERENCIA -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <span class="inline-flex w-fit items-center gap-1 rounded-full bg-violet-100 text-violet-800 px-2 py-0.5 text-xs">
                TRANSFERENCIA
              </span>

              <input
                type="number"
                min="0"
                step="0.01"
                class="w-full sm:w-[180px] lg:w-[200px] rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
                [value]="transferencia()"
                (input)="transferencia.set(($any($event.target).valueAsNumber ?? 0) || 0)" />
            </div>
          </div>
        </div>

        <!-- Resumen -->
        <div class="rounded-xl2 bg-ra-white shadow-card ring-1 ring-black/10 p-3 sm:p-4">
          <div class="text-sm font-semibold text-ra-slate mb-2">Resumen</div>

          <div class="text-sm flex justify-between">
            <span>Precio base</span>
            <span class="font-semibold">{{ precioBaseVista() | currency:'MXN':'symbol-narrow':'1.2-2' }}</span>
          </div>

          <div class="text-sm flex justify-between">
            <span>Inscripción</span>
            <span class="font-semibold">{{ inscripcionVista() | currency:'MXN':'symbol-narrow':'1.2-2' }}</span>
          </div>

          <div class="text-sm flex justify-between mt-2">
            <span>Descuento</span>
            <span class="font-semibold">− {{ (descuento() || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}</span>
          </div>

          <div class="text-sm flex justify-between mt-1">
            <span><strong>Total calculado (vista)</strong></span>
            <span class="font-semibold">{{ totalCalculadoVista() | currency:'MXN':'symbol-narrow':'1.2-2' }}</span>
          </div>

          <div class="text-sm flex justify-between">
            <span>Suma de pagos</span>
            <span class="font-semibold">{{ sumaPagos() | currency:'MXN':'symbol-narrow':'1.2-2' }}</span>
          </div>

          <div
            class="text-sm flex justify-between"
            [ngClass]="{ 'text-amber-700': desbalance() !== 0, 'text-emerald-700': desbalance() === 0 }">
            <span>Diferencia</span>
            <span class="font-semibold">{{ desbalance() | currency:'MXN':'symbol-narrow':'1.2-2' }}</span>
          </div>

          <button
            type="button"
            class="mt-3 w-full sm:w-auto px-3 py-1.5 rounded-md border text-sm"
            (click)="ajustarPagosAlTotal()">
            Igualar pagos al total
          </button>

          <div class="text-xs text-ra-slate/70 mt-2">
            El total definitivo lo recalcula el servidor al aplicar las acciones.
          </div>
        </div>
      </div>

      @if (error) {
        <div class="text-sm text-red-600">{{ error }}</div>
      }

      <!-- Footer -->
      <div class="flex flex-col-reverse sm:flex-row sm:items-center sm:justify-end gap-2 pt-1">
        <button
          type="button"
          (click)="cancelar.emit()"
          class="w-full sm:w-auto px-4 py-2 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100">
          Cancelar
        </button>

        <button
          type="button"
          [disabled]="guardando || !canSave()"
          class="w-full sm:w-auto px-5 py-2.5 rounded-full bg-[#0B2C4A] text-white hover:bg-[#0A2540] shadow-md disabled:opacity-60"
          (click)="guardar()">
          {{ guardando ? 'Guardando…' : 'Guardar cambios' }}
        </button>
      </div>
    }
  </div>
</div>
