<!-- Barra superior -->
<div class="mx-4 md:mx-10 mb-4 flex items-center justify-between">
  <div class="text-xl font-semibold text-ra-slate">Membresías</div>

  <div class="flex flex-wrap items-center gap-2">
    <!-- Buscar por ID -->
    <div class="flex items-center gap-2 mr-2">
      <input type="number" min="1" placeholder="ID membresía"
             class="w-[160px] rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
             [(ngModel)]="idBuscar"
             (keyup.enter)="buscarPorId()">
      <button type="button"
              class="px-3 py-2 rounded-md bg-[#0B2C4A] text-white hover:brightness-110 shadow-card text-sm disabled:opacity-60"
              [disabled]="buscando || !idBuscar"
              (click)="buscarPorId()">
        Buscar
      </button>
      <button type="button"
              class="px-3 py-2 rounded-md border text-sm disabled:opacity-60"
              [disabled]="buscando && !idBuscar"
              (click)="limpiarBusqueda()">
        Limpiar
      </button>
    </div>

    <!-- Orden -->
    <span class="hidden md:inline text-sm text-ra-slate/80">Ordenar por</span>
    <select class="rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
            [(ngModel)]="sortCampo" (change)="go(1)">
      <option [ngValue]="'fechaInicio'">F. inicio</option>
      <option [ngValue]="'fechaFin'">F. fin</option>
      <option [ngValue]="'idMembresia'">ID</option>
      <option [ngValue]="'total'">Total</option>
    </select>

    <select class="rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
            [(ngModel)]="sortDir" (change)="go(1)">
      <option [ngValue]="'desc'">Desc</option>
      <option [ngValue]="'asc'">Asc</option>
    </select>

    <!-- Size -->
    <label class="text-sm text-ra-slate/80 ml-2">Por página</label>
    <select class="rounded-xl border border-gray-200 bg-gray-100 px-3 py-2 shadow-inner text-sm"
            [(ngModel)]="sizeSel" (change)="go(1)">
      <option [ngValue]="10">10</option>
      <option [ngValue]="25">25</option>
      <option [ngValue]="50">50</option>
    </select>

    <button type="button"
            class="px-4 py-2 rounded-md bg-[#0B2C4A] text-white hover:brightness-110 shadow-card text-sm"
            (click)="go(1)">
      Actualizar
    </button>
  </div>
</div>

<!-- Tabla / Card -->
<div class="shadow-card rounded-xl2 overflow-hidden mx-4 md:mx-10 bg-ra-white ring-1 ring-black/10">
  <table class="w-full table-fixed text-[13px]">
    <colgroup>
      <col class="w-[7%]">
      <col class="w-[18%]">
      <col class="w-[16%]">
      <col class="w-[10%]">
      <col class="w-[10%]">
      <col class="w-[10%]">
      <col class="w-[18%]">
      <col class="w-[7%]">
      <col class="w-[10%]">
      <col class="w-[12%]">
      @if (esAdmin) { <col class="w-[16%]"> }
      <col class="w-[10%] min-w-[120px]">
    </colgroup>

    <thead>
      <tr class="bg-ra-grayLight/40">
        <th class="py-4 px-4 text-center text-ra-slate font-semibold uppercase">ID</th>
        <th class="py-4 px-4 text-left   text-ra-slate font-semibold uppercase">Socio</th>
        <th class="py-4 px-4 text-left   text-ra-slate font-semibold uppercase">Paquete</th>
        <th class="py-4 px-4 text-center text-ra-slate font-semibold uppercase">F. inicio</th>
        <th class="py-4 px-4 text-center text-ra-slate font-semibold uppercase">F. fin</th>
        <th class="py-4 px-4 text-center text-ra-slate font-semibold uppercase">Movimiento</th>
        <th class="py-4 px-4 text-left   text-ra-slate font-semibold uppercase">Pagos</th>
        <th class="py-4 px-4 text-center text-ra-slate font-semibold uppercase">Desc.</th>
        <th class="py-4 px-4 text-center text-ra-slate font-semibold uppercase">Total</th>
        <th class="py-4 px-4 text-center text-ra-slate font-semibold uppercase">Usuario</th>
        @if (esAdmin) {
          <th class="py-4 px-4 text-center text-ra-slate font-semibold uppercase">Gimnasio</th>
        }
        <th class="py-4 px-4 text-center text-ra-slate font-semibold uppercase">Acciones</th>
      </tr>
    </thead>

    <tbody>
      @if (cargando) {
        <tr><td [attr.colspan]="esAdmin ? 12 : 11" class="py-6 px-6 text-center text-ra-slate">Cargando…</td></tr>
      } @else if (error) {
        <tr><td [attr.colspan]="esAdmin ? 12 : 11" class="py-6 px-6 text-center text-red-600">{{ error }}</td></tr>
      } @else if (!rows.length) {
        <tr><td [attr.colspan]="esAdmin ? 12 : 11" class="py-6 px-6 text-center text-ra-slate">Sin resultados.</td></tr>
      } @else {
        @for (m of rows; track trackById($index, m)) {
          <tr class="border-t border-ra-grayLight/60 hover:bg-ra-bg">
            <td class="py-3 px-4 text-center font-medium">#{{ m.idMembresia }}</td>
            <td class="py-3 px-4">
              <div class="font-medium truncate">
                {{ m.socio.nombre }} {{ m.socio.apellido }}
              </div>
              <div class="text-xs text-ra-slate/70 truncate">
                ID: {{ m.socio.idSocio }} · {{ m.socio.telefono || '—' }}
              </div>
            </td>
            <td class="py-3 px-4">
              <div class="truncate font-medium">{{ m.paquete.nombre }}</div>
              <div class="text-xs text-ra-slate/70">{{ m.paquete.tiempo || '—' }}</div>
            </td>
            <td class="py-3 px-4 text-center">{{ m.fechaInicio | date:'dd/MM/yyyy' }}</td>
            <td class="py-3 px-4 text-center">{{ m.fechaFin    | date:'dd/MM/yyyy' }}</td>
            <td class="py-3 px-4 text-center">
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold"
                    [ngClass]="{
                      'bg-emerald-100 text-emerald-700': m.movimiento === 'INSCRIPCION',
                      'bg-indigo-100 text-indigo-700':  m.movimiento === 'REINSCRIPCION',
                      'bg-gray-100 text-gray-700':      m.movimiento !== 'INSCRIPCION' && m.movimiento !== 'REINSCRIPCION'
                    }">
                {{ m.movimiento }}
              </span>
            </td>
            <td class="py-3 px-4"><div class="truncate">{{ pagosChip(m) }}</div></td>
            <td class="py-3 px-4 text-center">
              {{ (m.descuento || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
            </td>
            <td class="py-3 px-4 text-center font-semibold">
              {{ (m.total || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
            </td>
            <td class="py-3 px-4 text-center">{{ m.usuario?.nombreUsuario || '—' }}</td>
            @if (esAdmin) {
              <td class="py-3 px-4 text-center">
                <span class="inline-flex items-center gap-1 rounded-full bg-[color:var(--color-ra-azul-fuerte)]/10 text-[color:var(--color-ra-azul-fuerte)] px-2 py-0.5 text-xs">
                  <svg viewBox="0 0 24 24" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 21h18M6 21V5h6v16M12 9h6v12"></path>
                  </svg>
                  {{ gymNombre(m.paquete.gimnasio || m.socio.gimnasio) }}
                </span>
              </td>
            }
            <td class="py-2 px-3">
              <div class="flex items-center justify-center gap-2">
                <button (click)="editar(m)" class="p-2 rounded hover:bg-ra-grayLight/40" title="Editar">
                  <img src="iconos/editar.svg" alt="Editar" class="w-5 h-5" />
                </button>
                <button (click)="eliminar(m)" class="p-2 rounded hover:bg-ra-grayLight/40" title="Eliminar">
                  <img src="iconos/eliminar.svg" alt="Eliminar" class="w-5 h-5" />
                </button>
              </div>
            </td>
          </tr>
        }
      }
    </tbody>
  </table>
</div>

<!-- Paginación -->
<div class="mx-4 md:mx-10 mt-3 mb-2 flex items-center justify-between text-sm">
  <div>
    Página <strong>{{ pageUI }}</strong> de <strong>{{ page.totalPages || 1 }}</strong>
    <span class="ml-2 text-ra-slate/70">({{ page.totalElements || 0 }} registros)</span>
  </div>
  <div class="flex items-center gap-2">
    <button class="rounded-md border px-3 py-1.5 bg-white disabled:opacity-50"
            [disabled]="!puedePrev" (click)="prev()">Anterior</button>
    <button class="rounded-md border px-3 py-1.5 bg-white disabled:opacity-50"
            [disabled]="!puedeNext" (click)="next()">Siguiente</button>
  </div>
</div>

<!-- Modal -->
@if (mostrarModal() && idEditando !== null) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" (click)="cerrarModal()"></div>
    <div class="relative z-10 w-full max-w-[820px] mx-4">
      <div class="bg-ra-white rounded-2xl shadow-2xl ring-1 ring-black/5">
        <app-membresia-modal
          [idMembresia]="idEditando"
          (cancelar)="cerrarModal()"
          (guardado)="onGuardado()">
        </app-membresia-modal>
      </div>
    </div>
  </div>
}
